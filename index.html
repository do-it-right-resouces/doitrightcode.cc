just like this nothing else HEN <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DO IT RIGHT - Barcode Generator</title>
<script src="https://cdn.jsdelivr.net/npm/bwip-js@4.5.1/dist/bwip-js-min.js"></script>

<style>
:root {
    --glass: rgba(255, 255, 255, 0.05);
    --glass-heavy: rgba(255, 255, 255, 0.12);
    --glass-border: rgba(255, 255, 255, 0.1);
    --neon-green: #00ff88;
    --neon-green-glow: rgba(0, 255, 136, 0.5);
    --neon-magenta: #ff00ff;
    --neon-magenta-glow: rgba(255, 0, 255, 0.5);
    --neon-yellow: #ffff00;
    --neon-orange: #ff8800;
    --neon-cyan: #00ffff;
    --void: #020205;
    --text: rgba(255, 255, 255, 0.9);
    --dither: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIElEQVQYV2P8////fwYGBgZGRkZGMI0uAMYEBmADGIEuAMYEBmAHAAD//wQMAPS8f9sAAAAASUVORK5CYII=');
}

@keyframes chromatic {
    0% { text-shadow: 2px 0 0 rgba(255,0,0,0.5), -2px 0 0 rgba(0,0,255,0.5); }
    50% { text-shadow: -2px 0 0 rgba(255,0,0,0.5), 2px 0 0 rgba(0,0,255,0.5); }
    100% { text-shadow: 2px 0 0 rgba(255,0,0,0.5), -2px 0 0 rgba(0,0,255,0.5); }
}

@keyframes scanline {
    0% { transform: translateY(-100%); }
    100% { transform: translateY(100%); }
}

@keyframes matrixRain {
    0% { background-position: 0% -1000%; }
    100% { background-position: 0% 0%; }
}

@keyframes resolveResolve {
    0% { filter: blur(20px) brightness(2); transform: translate(-50%, -50%) scale(2); opacity: 0; }
    100% { filter: blur(0) brightness(1); transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

@keyframes slideTransition {
    0% { transform: translateX(100%); filter: blur(10px); opacity: 0; }
    100% { transform: translateX(0); filter: blur(0); opacity: 1; }
}

@keyframes glitch {
    0% { transform: translate(0); }
    20% { transform: translate(-2px, 2px); }
    40% { transform: translate(-2px, -2px); }
    60% { transform: translate(2px, 2px); }
    80% { transform: translate(2px, -2px); }
    100% { transform: translate(0); }
}

.glitch-active {
    animation: glitch 0.3s cubic-bezier(.25,.46,.45,.94) both;
    filter: hue-rotate(90deg);
}

.decoding-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(rgba(0, 255, 136, 0.1) 50%, transparent 50%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><text x="0" y="20" fill="rgba(0,255,136,0.2)" font-family="monospace" font-size="10">01010110</text><text x="20" y="40" fill="rgba(0,255,136,0.2)" font-family="monospace" font-size="10">11001010</text><text x="40" y="60" fill="rgba(0,255,136,0.2)" font-family="monospace" font-size="10">10101101</text><text x="60" y="80" fill="rgba(0,255,136,0.2)" font-family="monospace" font-size="10">01100110</text></svg>');
    background-size: 100% 4px, 100px 100px;
    z-index: 10;
    display: none;
    pointer-events: none;
    animation: matrixRain 20s linear infinite;
}

.decoding-text {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: var(--neon-green);
    font-size: 2rem;
    font-weight: 900;
    text-shadow: 0 0 20px var(--neon-green);
    letter-spacing: 10px;
    z-index: 11;
}

.confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background: var(--neon-green);
    z-index: 100002;
    pointer-events: none;
}

* { box-sizing: border-box; margin: 0; padding: 0; cursor: default; }

body { 
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
    background: var(--void);
    color: var(--text);
    line-height: 1.6;
    overflow-x: hidden;
    min-height: 100vh;
    background-image: 
        radial-gradient(circle at 50% 50%, rgba(0, 255, 136, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 0% 0%, rgba(255, 0, 255, 0.03) 0%, transparent 40%),
        linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%),
        linear-gradient(90deg, rgba(255, 0, 0, 0.01), rgba(0, 255, 0, 0.005), rgba(0, 0, 255, 0.01));
    background-size: 100% 100%, 100% 100%, 100% 4px, 3px 100%;
    animation: ambientPulse 10s infinite alternate ease-in-out;
}

/* CRT Screen Curvature Effect */
body::before {
    content: " ";
    display: block;
    position: fixed;
    top: 0; left: 0; bottom: 0; right: 0;
    background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.2) 100%);
    pointer-events: none;
    z-index: 100004;
}

#crt-screen-mask {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
    z-index: 100003;
    pointer-events: none;
    background-size: 100% 3px, 3px 100%;
}

.bg-blobs {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1;
    pointer-events: none;
}

.blob {
    position: absolute;
    width: 500px; height: 500px;
    border-radius: 50%;
    filter: blur(100px);
    opacity: 0.1;
    animation: blobFloat 25s infinite alternate ease-in-out;
}

@keyframes blobFloat {
    0% { transform: translate(-20%, -20%) rotate(0deg); }
    100% { transform: translate(20%, 20%) rotate(360deg); }
}

@keyframes ambientPulse {
    0% { background-position: 0% 0%, 0% 0%; }
    100% { background-position: 10% 10%, -10% -10%; }
}

/* CRT Scanline & Flicker Overlay */
body::after {
    content: " ";
    display: block;
    position: fixed;
    top: 0; left: 0; bottom: 0; right: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
    z-index: 100000;
    background-size: 100% 2px, 3px 100%;
    pointer-events: none;
    opacity: 0.3;
}

body::before {
    content: " ";
    display: block;
    position: fixed;
    top: 0; left: 0; bottom: 0; right: 0;
    background: rgba(18, 16, 16, 0.1);
    opacity: 0;
    z-index: 100001;
    pointer-events: none;
    animation: flicker 0.15s infinite;
}

@keyframes flicker {
    0% { opacity: 0.1232; }
    5% { opacity: 0.0212; }
    10% { opacity: 0.1112; }
    15% { opacity: 0.0432; }
    20% { opacity: 0.1032; }
    25% { opacity: 0.0532; }
    30% { opacity: 0.1232; }
    35% { opacity: 0.0132; }
    40% { opacity: 0.1232; }
    45% { opacity: 0.1112; }
    50% { opacity: 0.1232; }
    55% { opacity: 0.0132; }
    60% { opacity: 0.1232; }
    65% { opacity: 0.1112; }
    70% { opacity: 0.1232; }
    75% { opacity: 0.1032; }
    80% { opacity: 0.1232; }
    85% { opacity: 0.0132; }
    90% { opacity: 0.1232; }
    95% { opacity: 0.1112; }
    100% { opacity: 0.1232; }
}

/* Glass Morphism Panels */
.panel { 
    background: var(--glass);
    backdrop-filter: blur(25px) saturate(200%);
    -webkit-backdrop-filter: blur(25px) saturate(200%);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8), inset 0 0 32px rgba(255,255,255,0.02);
    position: relative;
    overflow: hidden;
}

/* Glass Reflection Shine */
.panel::before {
    content: "";
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.05) 48%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 52%, transparent 55%);
    pointer-events: none;
    z-index: 2;
    transform: rotate(-45deg);
    animation: shine 12s infinite linear;
}

@keyframes shine {
    0% { transform: translate(-30%, -30%) rotate(-45deg); }
    100% { transform: translate(30%, 30%) rotate(-45deg); }
}

.panel::after {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: var(--dither);
    opacity: 0.08;
    pointer-events: none;
    z-index: 1;
}

.panel::before {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; height: 100%;
    background: linear-gradient(transparent 0%, rgba(255,255,255,0.02) 50%, transparent 100%);
    animation: scanline 8s linear infinite;
    pointer-events: none;
}

.panel-header {
    background: linear-gradient(90deg, rgba(0, 255, 136, 0.15) 0%, rgba(0, 255, 136, 0.05) 100%);
    color: var(--neon-green);
    padding: 0.75rem 1rem;
    margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    border-radius: 11px 11px 0 0;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 2px;
    border-bottom: 1px solid var(--neon-green);
    text-shadow: 0 0 10px var(--neon-green-glow);
}

/* Auth Overlay Glass */
.auth-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(circle at center, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.95) 100%);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
}
.auth-box {
    background: rgba(10, 10, 15, 0.7);
    backdrop-filter: blur(25px);
    border: 1px solid var(--neon-green);
    border-radius: 16px;
    padding: 2.5rem;
    width: 420px;
    max-width: 90vw;
    box-shadow: 0 0 50px rgba(0,255,136,0.15), inset 0 0 20px rgba(0,255,136,0.05);
}
.auth-logo-wrap {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 1.5rem;
    position: relative;
}
.logo-auth {
    width: 80px;
    height: 80px;
    object-fit: contain;
    filter: drop-shadow(0 0 10px var(--neon-green));
}
.auth-box h2 {
    color: var(--neon-green);
    text-align: center;
    margin-bottom: 2rem;
    text-shadow: 0 0 15px var(--neon-green-glow);
    font-size: 1.8rem;
    letter-spacing: 4px;
}
.auth-input {
    margin-bottom: 1rem;
}
.auth-btn {
    width: 100%;
    padding: 1rem;
    background: rgba(0, 255, 136, 0.1);
    border: 2px solid var(--neon-green);
    color: var(--neon-green);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 900;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    font-family: 'Consolas', monospace;
    margin-top: 1rem;
    transition: all 0.2s ease;
}
.auth-btn:hover {
    background: rgba(0, 255, 136, 0.2);
    box-shadow: 0 0 20px var(--neon-green-glow);
}
.auth-toggle {
    text-align: center;
    margin-top: 1.5rem;
    color: #888;
    font-size: 0.9rem;
    cursor: pointer;
    transition: color 0.2s;
}
.auth-toggle:hover {
    color: var(--neon-green);
}
.auth-error {
    background: rgba(255, 0, 0, 0.1);
    border: 1px solid #ff0000;
    color: #ff6666;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

/* Header Redesign */
header { 
    background: rgba(5, 5, 10, 0.6);
    backdrop-filter: blur(15px);
    border-bottom: 1px solid var(--neon-green);
    padding: 1rem 3rem; 
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.header-title h1 { 
    color: var(--neon-green); 
    font-size: 1.6rem; 
    font-weight: 700;
    text-shadow: 0 0 15px var(--neon-green-glow);
    letter-spacing: 3px;
}

/* Satisfying Chunky Buttons */
.btn {
    padding: 0.8rem 1.6rem;
    border: 2px solid var(--neon-green);
    background: rgba(0, 255, 136, 0.05);
    color: var(--neon-green);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 900;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-family: 'Consolas', monospace;
    position: relative;
    overflow: hidden;
    box-shadow: 0 6px 0 0 rgba(0, 255, 136, 0.3), 0 0 15px rgba(0, 255, 136, 0.1);
    text-shadow: 0 0 5px var(--neon-green-glow);
    z-index: 2;
}

.btn:hover {
    background: rgba(0, 255, 136, 0.15);
    transform: translateY(-2px);
    box-shadow: 0 8px 0 0 rgba(0, 255, 136, 0.4), 0 0 25px var(--neon-green-glow);
    animation: chromatic 0.2s infinite;
}

.btn:active {
    transform: translateY(4px);
    box-shadow: 0 2px 0 0 rgba(0, 255, 136, 0.2), inset 0 0 20px rgba(0, 255, 136, 0.2);
}

.btn-primary {
    background: rgba(255, 255, 0, 0.05);
    border-color: var(--neon-yellow);
    color: var(--neon-yellow);
    box-shadow: 0 6px 0 0 rgba(255, 255, 0, 0.3), 0 0 15px rgba(255, 255, 0, 0.1);
}

.btn-primary:hover {
    background: rgba(255, 255, 0, 0.15);
    box-shadow: 0 8px 0 0 rgba(255, 255, 0, 0.4), 0 0 25px rgba(255, 255, 0, 0.3);
}

.btn-primary:active {
    box-shadow: 0 2px 0 0 rgba(255, 255, 0, 0.2);
}

/* Glass Inputs */
.auth-input, .field-input input, .config-item select, .auth-input {
    width: 100%;
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--glass-border);
    color: var(--neon-green);
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
}

.field-input input:focus, .auth-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.06);
    border-color: var(--neon-green);
    box-shadow: 0 0 20px var(--neon-green-glow), inset 0 0 10px var(--neon-green-glow);
    border-right: 8px solid var(--neon-green);
    animation: cursorBlink 1s infinite steps(2);
}

@keyframes cursorBlink {
    0% { border-right-color: transparent; }
    50% { border-right-color: var(--neon-green); }
}

/* Liquid Progress Bar */
.progress-container {
    width: 100%;
    height: 12px;
    background: var(--glass-heavy);
    border: 1px solid var(--glass-border);
    border-radius: 6px;
    margin: 1rem 0;
    overflow: hidden;
    display: none;
    position: relative;
}

.progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan));
    box-shadow: 0 0 15px var(--neon-green);
    position: relative;
    transition: width 0.1s ease;
}

.progress-fill::after {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: linear-gradient(
        -45deg, 
        rgba(255, 255, 255, .2) 25%, 
        transparent 25%, 
        transparent 50%, 
        rgba(255, 255, 255, .2) 50%, 
        rgba(255, 255, 255, .2) 75%, 
        transparent 75%, 
        transparent
    );
    background-size: 50px 50px;
    animation: moveStripes 2s linear infinite;
}

@keyframes moveStripes {
    0% { background-position: 0 0; }
    100% { background-position: 50px 50px; }
}

/* Micro-rewards: Field states */
.field-row {
    display: grid;
    grid-template-columns: 140px 1fr 120px;
    gap: 1rem;
    align-items: center;
    padding: 0.8rem 1rem;
    border-bottom: 1px solid var(--glass-border);
    transition: all 0.3s ease;
    border-left: 0px solid var(--neon-green);
}

.field-row:hover {
    background: rgba(255, 255, 255, 0.02);
    border-left-width: 4px;
    padding-left: calc(1rem - 4px);
}

.field-label {
    font-size: 0.85rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.6);
    letter-spacing: 1px;
}

.field-label.mandatory { color: var(--neon-yellow); }
.field-label.always-include { color: var(--neon-orange); }

/* Toggle Snaps */
.toggle-switch input[type="checkbox"] {
    width: 54px;
    height: 28px;
    background: var(--glass-heavy);
    border: 1px solid var(--glass-border);
    transition: all 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.toggle-switch input[type="checkbox"]:checked {
    background: var(--neon-magenta);
    box-shadow: 0 0 15px var(--neon-magenta-glow);
}

.toggle-switch input[type="checkbox"]::before {
    top: 3px; left: 3px;
    width: 20px; height: 20px;
    background: var(--text);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.toggle-switch input[type="checkbox"]:checked::before {
    left: 29px;
    background: #fff;
}

/* Crypto Status Badges */
.crypto-status {
    padding: 0.3rem 0.7rem;
    border-radius: 4px;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.crypto-status.on {
    background: var(--neon-magenta);
    color: #fff;
    box-shadow: 0 0 20px var(--neon-magenta-glow);
    animation: neonPulse 2s infinite alternate;
}

@keyframes neonPulse {
    from { box-shadow: 0 0 10px var(--neon-magenta-glow); }
    to { box-shadow: 0 0 25px var(--neon-magenta-glow); }
}

@keyframes powerUpFlash {
    0% { background: transparent; }
    50% { background: rgba(255, 0, 255, 0.2); }
    100% { background: transparent; }
}

.power-up-effect {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 100003;
    pointer-events: none;
    animation: powerUpFlash 0.4s ease-out;
}

/* Hex Display Redesign */
.hex-display {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--glass-border);
    color: var(--neon-green);
    border-radius: 8px;
    padding: 1.2rem;
    font-size: 0.8rem;
    line-height: 1.6;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
}

/* Chat Widget Glass */
#help-avatar {
    border: 2px solid var(--neon-green);
    background: var(--glass-heavy);
    backdrop-filter: blur(10px);
}

.help-panel {
    background: rgba(10, 10, 15, 0.8);
    backdrop-filter: blur(25px);
    border: 1px solid var(--neon-green);
    box-shadow: 0 15px 40px rgba(0,0,0,0.6);
}

/* Alerts */
.alert {
    border: 1px solid transparent;
    backdrop-filter: blur(10px);
    border-radius: 8px;
}
.alert-success { 
    background: rgba(0, 255, 136, 0.1); 
    border-color: var(--neon-green); 
    color: var(--neon-green); 
    box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
}

/* Scrollbars */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--void); }
::-webkit-scrollbar-thumb { 
    background: var(--glass-heavy); 
    border-radius: 10px;
    border: 2px solid var(--void);
}
::-webkit-scrollbar-thumb:hover { background: var(--neon-green); }

/* Interactive Logo Smoke (Magenta/Green mix) */
.smoke-container {
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 30px;
    pointer-events: none;
    overflow: visible;
}
.smoke-puff {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, var(--neon-green), transparent);
    animation: smokeRise 2s ease-out forwards;
    opacity: 0.6;
}
.smoke-puff.left {
    left: 12px;
}
.smoke-puff.right {
    left: 42px;
}
@keyframes smokeRise {
    0% {
        transform: translateY(0) scale(0.5);
        opacity: 0.6;
    }
    50% {
        opacity: 0.4;
    }
    100% {
        transform: translateY(-30px) scale(1.5);
        opacity: 0;
    }
}
.auth-smoke .smoke-puff {
    background: radial-gradient(circle at 30% 30%, var(--neon-magenta), transparent);
}

.container { max-width: 1400px; padding: 3rem 2rem; }
.layout-grid { gap: 3rem; }

/* Phosphor Glow on specific text */
.state-indicator, .header-user-email, .badge-required {
    text-shadow: 0 0 8px currentColor;
}

/* Phosphor Persistence (Ghosting) */
.ghost-text {
    position: relative;
    display: inline-block;
}
.ghost-text::after {
    content: attr(data-text);
    position: absolute;
    top: 0; left: 2px;
    color: var(--neon-green);
    opacity: 0.3;
    filter: blur(2px);
    z-index: -1;
    pointer-events: none;
}

/* --- Added Missing CSS Classes --- */

/* Header Layout */
.header-left { display: flex; align-items: center; gap: 1.5rem; }
.header-logo-wrap { position: relative; width: 60px; height: 60px; }
#page-logo { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 5px var(--neon-green)); cursor: pointer; }
.subtitle { font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); letter-spacing: 1px; }
.header-user { display: flex; align-items: center; gap: 1rem; font-size: 0.85rem; }
.header-user-info { color: rgba(255, 255, 255, 0.7); border-right: 1px solid var(--glass-border); padding-right: 1rem; }
.header-user-email { color: var(--neon-green); font-weight: bold; }
.btn-logout { background: transparent; border: 1px solid var(--neon-magenta); color: var(--neon-magenta); padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
.btn-logout:hover { background: rgba(255, 0, 255, 0.1); box-shadow: 0 0 10px var(--neon-magenta-glow); }

/* Config Grid */
.config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
.config-item { display: flex; flex-direction: column; gap: 0.5rem; }
.config-item label { font-size: 0.75rem; color: var(--neon-cyan); text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
.state-indicator { font-family: 'Courier New', monospace; color: var(--neon-yellow); font-weight: bold; }

/* Cryptography Toggle Section */
.crypto-toggle-section { margin-top: 2rem; padding-top: 2rem; border-top: 1px dashed var(--glass-border); }
.crypto-toggle-section h3 { font-size: 0.9rem; color: var(--neon-magenta); margin-bottom: 1.5rem; letter-spacing: 2px; }
.toggle-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
.toggle-item { background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border); border-radius: 8px; padding: 1rem; transition: all 0.3s; }
.toggle-item:hover { border-color: var(--neon-magenta); background: rgba(255, 0, 255, 0.02); }
.toggle-item.active { border-color: var(--neon-magenta); box-shadow: inset 0 0 15px rgba(255, 0, 255, 0.05); }
.toggle-label { display: flex; align-items: center; justify-content: space-between; width: 100%; font-weight: bold; font-size: 0.85rem; color: #fff; }
.toggle-description { font-size: 0.75rem; color: #888; margin-top: 0.75rem; line-height: 1.4; }

/* Badges */
.badge { font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 3px; font-weight: bold; text-align: center; min-width: 80px; }
.badge-required { background: rgba(255, 255, 0, 0.1); color: var(--neon-yellow); border: 1px solid var(--neon-yellow); }
.badge-optional { background: rgba(0, 255, 136, 0.1); color: var(--neon-green); border: 1px solid var(--neon-green); }
.badge-always { background: rgba(255, 136, 0, 0.1); color: var(--neon-orange); border: 1px solid var(--neon-orange); }
.badge-encrypted { background: rgba(255, 0, 255, 0.1); color: var(--neon-magenta); border: 1px solid var(--neon-magenta); text-shadow: 0 0 5px var(--neon-magenta-glow); }

/* Legend */
.legend { display: flex; flex-wrap: wrap; gap: 1.5rem; margin: 1.5rem 0; padding: 1rem; background: rgba(255, 255, 255, 0.02); border-radius: 8px; font-size: 0.75rem; }
.legend-item { display: flex; align-items: center; gap: 0.5rem; }
.legend-color { width: 12px; height: 12px; border-radius: 2px; }

/* Controls & Layout */
.controls { display: flex; flex-wrap: wrap; gap: 1rem; margin: 2rem 0; }
.checkbox-wrapper { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #aaa; margin-top: 1rem; }
.section-divider { margin: 2rem 0 1rem; font-size: 0.8rem; font-weight: bold; color: var(--neon-cyan); letter-spacing: 2px; border-bottom: 1px solid rgba(0, 255, 255, 0.2); padding-bottom: 0.5rem; }
.field-input { flex: 1; }

/* Payment Modal */
.payment-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); z-index: 100006; display: none; align-items: center; justify-content: center; }
.payment-modal.active { display: flex; }
.payment-box { background: #0a0a0f; border: 2px solid var(--neon-green); border-radius: 16px; padding: 2rem; width: 450px; max-width: 90vw; box-shadow: 0 0 50px rgba(0, 255, 136, 0.2); }
.payment-box h3 { color: var(--neon-green); margin-bottom: 1.5rem; text-align: center; letter-spacing: 2px; }
.payment-amount { font-size: 2rem; font-weight: 900; color: #fff; text-align: center; margin-bottom: 1.5rem; text-shadow: 0 0 20px rgba(255, 255, 255, 0.2); }
.payment-tab { flex: 1; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: #888; cursor: pointer; transition: all 0.3s; font-family: inherit; font-weight: bold; }
.payment-tab.active { background: rgba(0, 255, 136, 0.1); border-color: var(--neon-green); color: var(--neon-green); }
.payment-method { margin-top: 1.5rem; padding: 1.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 8px; border: 1px solid var(--glass-border); }
.btc-address { font-family: monospace; background: #000; padding: 0.75rem; border-radius: 4px; border: 1px solid #333; color: var(--neon-yellow); font-size: 0.8rem; word-break: break-all; margin-bottom: 1rem; }
.btc-qr { width: 180px; height: 180px; margin: 0 auto; display: block; border: 10px solid #fff; border-radius: 8px; }
.payment-close { margin-top: 1.5rem; padding: 0.8rem 1.5rem; background: transparent; border: 1px solid #444; color: #888; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
.payment-close:hover { background: rgba(255, 255, 255, 0.05); color: #fff; }

/* Admin Sections */
.admin-tab.active { background: var(--neon-green) !important; color: #000 !important; }
.admin-section { animation: slideTransition 0.4s ease-out; }
.audit-entry { padding: 0.6rem; border-bottom: 1px solid rgba(0, 255, 136, 0.1); display: flex; gap: 1rem; align-items: center; }
.audit-time { color: #666; font-size: 0.7rem; min-width: 140px; }
.audit-type { font-size: 0.65rem; padding: 0.1rem 0.4rem; border-radius: 3px; font-weight: bold; min-width: 70px; text-align: center; }
.audit-type.login { color: var(--neon-cyan); border: 1px solid var(--neon-cyan); }
.audit-type.payment { color: var(--neon-yellow); border: 1px solid var(--neon-yellow); }
.audit-type.generate { color: var(--neon-green); border: 1px solid var(--neon-green); }
.audit-type.error { color: var(--neon-magenta); border: 1px solid var(--neon-magenta); }

/* Checksum Comparison */
.checksum-comparison { margin-top: 1.5rem; padding: 1.2rem; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 1px solid var(--glass-border); }
.checksum-row { display: grid; grid-template-columns: 140px 1fr 100px; gap: 1rem; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
.checksum-label { font-size: 0.75rem; color: #888; font-weight: bold; }
.checksum-value { font-family: monospace; font-size: 0.8rem; color: var(--neon-green); word-break: break-all; }
.checksum-time { font-size: 0.7rem; color: #555; text-align: right; }

/* Status Indicators */
.status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
.status-ok { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
.status-error { background: var(--neon-magenta); box-shadow: 0 0 10px var(--neon-magenta); }
.status-warning { background: var(--neon-yellow); box-shadow: 0 0 10px var(--neon-yellow); }
.status-crypto { background: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }

/* Alerts Extensions */
.alert-info { background: rgba(0, 255, 255, 0.05); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 1rem; border-radius: 8px; font-size: 0.85rem; line-height: 1.5; }
.alert-warning { background: rgba(255, 255, 0, 0.05); border: 1px solid var(--neon-yellow); color: var(--neon-yellow); padding: 1rem; border-radius: 8px; font-size: 0.85rem; }
.alert-error { background: rgba(255, 0, 0, 0.05); border: 1px solid #ff0000; color: #ff6666; padding: 1rem; border-radius: 8px; font-size: 0.85rem; }

/* Encryption Indicators */
.encrypted-label { color: var(--neon-magenta) !important; }
.encrypted-input { border-color: var(--neon-magenta) !important; }
.encryption-indicator { font-size: 0.8rem; margin-left: 5px; filter: drop-shadow(0 0 5px var(--neon-magenta)); }

/* Help Widget Extensions */
.help-widget { position: fixed; bottom: 30px; right: 30px; z-index: 100005; }
.help-toggle { width: 60px; height: 60px; border-radius: 50%; cursor: pointer; position: relative; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.help-toggle:hover { transform: scale(1.1); }
#help-avatar { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; box-shadow: 0 0 20px var(--neon-green-glow); }
.help-panel { position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px; border-radius: 16px; display: none; flex-direction: column; overflow: hidden; z-index: 100005; }
.help-panel.active { display: flex; animation: slideTransition 0.3s reverse; }
.help-panel-header { padding: 1rem; background: var(--neon-green); color: #000; display: flex; align-items: center; gap: 0.75rem; font-weight: 900; font-size: 0.85rem; text-transform: uppercase; }
.help-panel-header img { width: 24px; height: 24px; filter: invert(1); }
.help-messages { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; background: rgba(0, 0, 0, 0.4); }
.help-msg { max-width: 85%; padding: 0.75rem 1rem; border-radius: 12px; font-size: 0.85rem; line-height: 1.4; }
.help-msg.bot { align-self: flex-start; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border); color: #fff; border-bottom-left-radius: 2px; }
.help-msg.user { align-self: flex-end; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--neon-green); color: var(--neon-green); border-bottom-right-radius: 2px; }
.help-input-area { padding: 1rem; background: rgba(0, 0, 0, 0.5); border-top: 1px solid var(--glass-border); display: flex; gap: 0.5rem; }
.help-input-area input { flex: 1; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 6px; padding: 0.6rem; color: #fff; font-family: inherit; font-size: 0.85rem; }
.help-input-area button { background: var(--neon-green); border: none; padding: 0 1rem; border-radius: 6px; font-weight: bold; cursor: pointer; }

/* Messenger Widget */
.messenger-widget { position: fixed; bottom: 30px; left: 30px; width: 300px; height: 400px; background: rgba(10, 10, 15, 0.9); backdrop-filter: blur(20px); border: 1px solid var(--neon-green); border-radius: 12px; display: none; flex-direction: column; z-index: 10000; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
.messenger-widget.active { display: flex; }
.messenger-header { padding: 0.75rem 1rem; background: rgba(0, 255, 136, 0.1); border-bottom: 1px solid var(--neon-green); color: var(--neon-green); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; }
.messenger-messages { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.8rem; }
.messenger-message { padding: 0.6rem; border-radius: 6px; background: rgba(255, 255, 255, 0.05); border-left: 3px solid #555; }
.messenger-message.admin { border-left-color: var(--neon-green); color: var(--neon-green); }
.messenger-message.user { border-left-color: var(--neon-cyan); color: var(--neon-cyan); }
.messenger-input-area { padding: 0.75rem; display: flex; gap: 0.5rem; border-top: 1px solid var(--glass-border); }
.messenger-input-area input { flex: 1; background: rgba(0, 0, 0, 0.3); border: 1px solid #333; border-radius: 4px; padding: 0.5rem; color: #fff; font-size: 0.8rem; }

/* Footer */
footer { text-align: center; padding: 4rem 2rem; border-top: 1px solid var(--glass-border); margin-top: 4rem; color: #666; font-size: 0.8rem; letter-spacing: 1px; }

/* Animations */
@keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
.bounce { animation: bounce 0.5s ease; }

</style>
</head>
<body>

<div id="crt-screen-mask"></div>

<!-- Ambient Background Blobs -->
<div class="bg-blobs">
    <div class="blob" style="background: var(--neon-green); top: -10%; left: -10%;"></div>
    <div class="blob" style="background: var(--neon-magenta); bottom: -10%; right: -10%; animation-delay: -5s;"></div>
    <div class="blob" style="background: var(--neon-cyan); top: 40%; left: 60%; animation-delay: -10s; width: 300px; height: 300px;"></div>
</div>

<!-- Auth Overlay -->
<div id="auth-overlay" class="auth-overlay">
    <div class="auth-box">
        <div class="auth-logo-wrap">
            <img src="assets/logo.png" alt="DO IT RIGHT" class="logo-auth" id="auth-logo">
            <div id="auth-logo-smoke" class="smoke-container auth-smoke" aria-hidden="true"></div>
        </div>
        <h2 id="auth-title">Login</h2>
        <div id="auth-error" class="auth-error" style="display:none;"></div>
        <input type="email" id="auth-email" class="auth-input" placeholder="Email Address">
        <input type="password" id="auth-password" class="auth-input" placeholder="Password">
        <div id="register-fields" style="display:none;">
            <input type="password" id="auth-confirm" class="auth-input" placeholder="Confirm Password">
        </div>
        <button id="auth-submit" class="auth-btn">Login</button>
        <div id="auth-toggle" class="auth-toggle">Don't have an account? Register</div>
    </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="payment-modal">
    <div class="payment-box">
        <h3>‚ö° Payment Required</h3>
        <div id="payment-type-display" style="color:#00ff00; margin-bottom:1rem;">Barcode Generation - $10</div>
        <div class="payment-amount" id="payment-amount-display">$10.00 USD</div>
        
        <!-- Payment Method Tabs -->
        <div style="display:flex; gap:0.5rem; margin:1rem 0;">
            <button class="payment-tab active" id="tab-btc" onclick="showPaymentTab('btc')">‚Çø Bitcoin</button>
            <button class="payment-tab" id="tab-ln" onclick="showPaymentTab('ln')">‚ö° Lightning</button>
        </div>
        
        <!-- Bitcoin Payment -->
        <div id="payment-btc" class="payment-method active">
            <p style="color:#888; font-size:0.85rem; margin:0.5rem 0;">Send Bitcoin to:</p>
            <div class="btc-address" id="btc-address">bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh</div>
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" id="btc-qr-img" class="btc-qr" alt="Bitcoin QR" style="display:block;">
        </div>
        
        <!-- Lightning Payment -->
        <div id="payment-ln" class="payment-method" style="display:none;">
            <p style="color:#888; font-size:0.85rem; margin:0.5rem 0;">Pay with Lightning Network:</p>
            <div class="btc-address" id="ln-invoice" style="font-size:0.65rem; word-break:break-all;">lnbc1p5hunjvdqdgdshx6pqg9c8qpp5qxq5vvgl90mq7npt0xn75358hgqjtfzerkd2fd6e2yesc8eplcwqsp5vwv5q4ahupz0jaf9h332d858rhz0nm5h8uwcp9l8qkl9rs4chths9qrsgqcqpcxqy8ayqrzjqfzhphca8jlc5zznw52mnqxsnymltjgg3lxe4ul82g42vw0jpkgkwz6p3yqqt9sqqqqqqqqqqqqqqqqq9grzjqv06k0m23t593pngl0jt7n9wznp64fqngvctz7vts8nq4tukvtljqztad5qqrdqqqcqqqqqqqqqqqqqq9gdyq7w0j9pgnd3cnypsvq67lne8lcxzfxda3zlkwtsw8fm8n3pp79lsyxmemdnnhsgev7zuhce44mk3x3naxmwf9ygnnglmw9userg6sq8g9w7n</div>
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" id="ln-qr-img" class="btc-qr" alt="Lightning QR" style="display:block;">
            <p style="color:#ff9900; font-size:0.75rem; margin-top:0.5rem;">‚ö° Instant confirmation with Lightning!</p>
        </div>
        
        <p style="color:#888; font-size:0.8rem; margin-top:1rem;">Payment confirms automatically</p>
        <button class="payment-close" onclick="closePaymentModal()">Close</button>
        <button class="payment-close" style="background:#003300; border-color:#00ff00; color:#00ff00; margin-left:0.5rem;" onclick="simulatePayment()">I've Paid</button>
    </div>
</div>

<header>
    <div class="header-left">
        <div class="header-logo-wrap">
            <img id="page-logo" src="assets/logo.png" alt="DO IT RIGHT">
            <div id="logo-smoke" class="smoke-container" aria-hidden="true"></div>
        </div>
        <div class="header-title">
            <h1 class="ghost-text" data-text="DO IT RIGHT RESOURCES">DO IT RIGHT RESOURCES</h1>
            <div class="subtitle">Barcode Generator | AAMVA Compliant</div>
        </div>
    </div>
    <div class="header-user" id="header-user" style="display:none;">
        <div class="header-user-info">
            Logged in as: <span class="header-user-email" id="user-email-display"></span>
        </div>
        <button class="btn-logout" id="btn-main-logout">Logout</button>
    </div>
</header> 

<main class="container">
    
    <div class="panel">
        <div class="panel-header">‚öôÔ∏è CONFIGURATION</div>
        
        <div class="config-grid">
            <div class="config-item">
                <label>State Profile:</label>
                <select id="profile-state">
                    <option value="FL">Florida (FL) - 636026</option>
                    <option value="CA">California (CA) - 636014</option>
                    <option value="TX">Texas (TX) - 636015</option>
                    <option value="NY">New York (NY) - 636001</option>
                    <option value="GA">Georgia (GA) - 636055</option>
                    <option value="NC">North Carolina (NC) - 636004</option>
                    <option value="PA">Pennsylvania (PA) - 636025</option>
                    <option value="OH">Ohio (OH) - 636023</option>
                    <option value="IL">Illinois (IL) - 636035</option>
                    <option value="AZ">Arizona (AZ) - 636039</option>
                    <option value="NV">Nevada (NV) - 636049</option>
                    <option value="CO">Colorado (CO) - 636020</option>
                    <option value="WA">Washington (WA) - 636045</option>
                    <option value="NJ">New Jersey (NJ) - 636036</option>
                    <option value="VA">Virginia (VA) - 636000</option>
                    <option value="MI">Michigan (MI) - 636032</option>
                    <option value="TN">Tennessee (TN) - 636053</option>
                    <option value="MD">Maryland (MD) - 636003</option>
                    <option value="MA">Massachusetts (MA) - 636002</option>
                    <option value="IN">Indiana (IN) - 636037</option>
                </select>
            </div>
            
            <div class="config-item">
                <label>AAMVA Version:</label>
                <select id="profile-aamva">
                    <option value="08">Version 08 (2013-2016)</option>
                    <option value="09" selected>Version 09 (2016-2020)</option>
                    <option value="10">Version 10 (2020+)</option>
                </select>
            </div>
            
            <div class="config-item">
                <label>Jurisdiction Version:</label>
                <select id="profile-jurisdiction">
                    <option value="01" selected>Version 01</option>
                    <option value="02">Version 02</option>
                </select>
            </div>
            
            <div class="config-item">
                <label>Current Configuration:</label>
                <div id="config-display" class="state-indicator">FL v09 Jur 01</div>
            </div>
            
            <div class="config-item" id="inventory-number-config">
                <label>Inventory Number (Audit Trail):</label>
                <input type="text" id="inventory-number" value="FLDMVAUDIT000001" style="width:100%; padding:0.5rem; background:#001a00; border:2px solid #ffff00; color:#ffff00; border-radius:4px; font-family:'Courier New',monospace; font-size:0.9rem;" maxlength="16" placeholder="16-char audit trail">
                <div style="color:#888; font-size:0.75rem; margin-top:0.25rem;">Appended after ZF close + CRC (16 chars)</div>
            </div>
        </div>
        
        <!-- CRYPTOGRAPHY TOGGLE SECTION -->
        <div class="crypto-toggle-section">
            <h3>üîê CRYPTOGRAPHY & CHECKSUM CONTROLS</h3>
            <div class="toggle-container">
                
                <div class="toggle-item" id="aes-toggle-panel">
                    <div class="toggle-switch">
                        <input type="checkbox" id="enable-aes256">
                        <label for="enable-aes256" class="toggle-label">
                            AES-256 Encryption
                            <span class="crypto-status off" id="aes-status">OFF</span>
                        </label>
                    </div>
                    <div class="toggle-description">
                        Encrypts sensitive fields (name, DOB, address) using AES-256-GCM.
                        Data becomes unreadable but maintains structure.
                    </div>
                </div>
                
                <div class="toggle-item" id="md5-toggle-panel">
                    <div class="toggle-switch">
                        <input type="checkbox" id="enable-md5">
                        <label for="enable-md5" class="toggle-label">
                            MD5 Checksum
                            <span class="crypto-status off" id="md5-status">OFF</span>
                        </label>
                    </div>
                    <div class="toggle-description">
                        Adds MD5 hash alongside CRC-16. Compare speed and collision resistance. (Legacy/compatibility use)
                    </div>
                </div>

                <div class="toggle-item" id="md5-api-key-ref" style="border-color:#00AAFF; display:none;">
                    <div class="toggle-switch">
                        <label class="toggle-label" style="margin-right:0.5rem; color:#00AAFF;">Admin API Key (reference)</label>
                        <input type="text" id="admin-api-key-input" placeholder="Paste admin API key" style="background:#001a00; border:2px solid #00AAFF; color:#00ff00; padding:0.4rem; border-radius:4px; width:260px;">
                        <button class="btn" id="btn-set-api-key">Set API Key</button>
                    </div>
                    <div class="toggle-description">
                        Optional reference key used to call the admin endpoint (<code>/admin/control?token=...)</code>. Stored locally in your browser for convenience.
                    </div>
                </div>


            </div>

                <div class="toggle-item" id="hmac-toggle-panel" style="border-color:#00CC88;">
                    <div class="toggle-switch">
                        <input type="checkbox" id="enable-hmac">
                        <label for="enable-hmac" class="toggle-label">
                            HMAC-SHA256 (Sign Payload)
                            <span class="crypto-status off" id="hmac-status">OFF</span>
                        </label>
                    </div>
                    <div class="toggle-description">
                        Sign the canonical payload with HMAC-SHA256 and append the 32-byte MAC before padding. Recommended for production integrity. Use <strong>Generate Key</strong> or import a hex key.
                    </div>
                    <div style="margin-top:0.75rem; display:flex; gap:0.5rem; align-items:center;">
                        <input type="text" id="hmac-key-hex" placeholder="Import key (hex) or generate" style="background:#001a00; border:2px solid #00CC88; color:#00ff00; padding:0.4rem; border-radius:4px; width:360px;">
                        <button class="btn" id="btn-import-hmac-key">Import Key</button>
                        <button class="btn" id="btn-generate-hmac-key">Generate Key</button>
                    </div>
                    <div style="margin-top:0.5rem; color:#ccffdd; font-size:0.85rem;">Key ID: <span id="hmac-key-id">(none)</span></div>
                </div>

                <div class="toggle-item" id="admin-control-panel" style="border-color:#00FFFF;">
                    <div class="toggle-switch">
                        <input type="password" id="admin-token-input" placeholder="Enter admin token" style="padding:0.4rem;">
                        <button class="btn" id="btn-admin-unlock">üîí Unlock Admin</button>
                        <span class="crypto-status off" id="admin-status">ADMIN OFF</span>
                    </div>
                    <div class="toggle-description">
                        Admin control panel. You can also validate via an API endpoint at <code>/admin/control?token=...</code> if your server implements it. For local control the token is <code>3100-31-3100</code> (hardcoded per request).
                    </div>
                </div>

            <div id="encryption-key-display" style="display: none; margin-top: 1rem; padding: 1rem; background: #0a0a0a; border: 2px solid #ff00ff; border-radius: 6px;">
                <strong style="color: #ff00ff;">üîë Encryption Key (Session):</strong>
                <div style="color: #ffff00; font-family: 'Courier New', monospace; word-break: break-all; margin-top: 0.5rem;" id="aes-key-display"></div>
                <div style="color: #cc99ff; font-size: 0.85rem; margin-top: 0.5rem;">
                    ‚ö†Ô∏è Key changes each session. In production, use secure key management!
                </div>
            </div>
        </div>
        
        <div class="legend">
            <strong>Field Inclusion Legend:</strong><br>
            <div class="legend-item">
                <span class="legend-color" style="background: #ffff00;"></span>
                <span>REQUIRED (Must have data)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #ff8800;"></span>
                <span>ALWAYS INCLUDE (Even if empty)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #00ff00;"></span>
                <span>OPTIONAL (Omit if empty)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #ff00ff;"></span>
                <span>üîê ENCRYPTED (AES-256)</span>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" id="btn-generate">‚ö° GENERATE BARCODE</button>
            <button class="btn" id="btn-validate">‚úì VALIDATE</button>
            <button class="btn" id="btn-download">üíæ DOWNLOAD PNG</button>
            <button class="btn" id="btn-reset">üîÑ RESET DATA</button>
            <button class="btn" id="btn-test">üß™ RUN TESTS</button>
        </div>
        
        <div class="checkbox-wrapper">
            <input type="checkbox" id="strict-mode" checked>
            <label for="strict-mode">Strict DMV Validation Mode</label>
        </div>

        <div id="gen-progress-container" class="progress-container">
            <div id="gen-progress-fill" class="progress-fill"></div>
        </div>
        
        <div id="validation-status"></div>
    </div>
    
    <div class="layout-grid">
        
        <!-- Admin Control Panel - only shown when logged in as admin -->
        <div class="panel" id="secure-panel" style="display:none;">
            <div class="panel-header">üîê ADMIN CONTROL CENTER</div>
            <div id="secure-actions">
                <!-- Admin Nav Tabs -->
                <div style="display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap;">
                    <button class="btn admin-tab active" onclick="showAdminTab('payments')">üí∞ Payments</button>
                    <button class="btn admin-tab" onclick="showAdminTab('audit')">üìã Audit Log</button>
                    <button class="btn admin-tab" onclick="showAdminTab('users')">üë• Users</button>
                    <button class="btn admin-tab" onclick="showAdminTab('balances')">üí≥ Balances</button>
                </div>

                <div id="secure-content">
                    <!-- Payment Processor Panel -->
                    <div id="admin-payments" class="admin-section">
                        <h4 style="color:#ff9900;">üí∞ Payment Processor</h4>
                        <div style="background:#001a00; border:2px solid #ff9900; border-radius:6px; padding:1rem; margin-bottom:1rem;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                                <div>
                                    <label style="color:#ffff00; font-size:0.85rem;">Bitcoin Address</label>
                                    <input type="text" id="admin-btc-address" value="bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh" style="width:100%; padding:0.5rem; background:#000; border:2px solid #00ff00; color:#00ff00; border-radius:4px; font-family:monospace; font-size:0.8rem;">
                                </div>
                                <div>
                                    <label style="color:#ffff00; font-size:0.85rem;">Barcode Price ($)</label>
                                    <input type="number" id="admin-barcode-price" value="10" style="width:100%; padding:0.5rem; background:#000; border:2px solid #00ff00; color:#00ff00; border-radius:4px;">
                                </div>
                            </div>
                            <div style="margin-top:1rem;">
                                <label style="color:#ffff00; font-size:0.85rem;">Lightning Invoice</label>
                                <textarea id="admin-ln-invoice" rows="3" style="width:100%; padding:0.5rem; background:#000; border:2px solid #ff9900; color:#ff9900; border-radius:4px; font-family:monospace; font-size:0.7rem;">lnbc1p5hunjvdqdgdshx6pqg9c8qpp5qxq5vvgl90mq7npt0xn75358hgqjtfzerkd2fd6e2yesc8eplcwqsp5vwv5q4ahupz0jaf9h332d858rhz0nm5h8uwcp9l8qkl9rs4chths9qrsgqcqpcxqy8ayqrzjqfzhphca8jlc5zznw52mnqxsnymltjgg3lxe4ul82g42vw0jpkgkwz6p3yqqt9sqqqqqqqqqqqqqqqqq9grzjqv06k0m23t593pngl0jt7n9wznp64fqngvctz7vts8nq4tukvtljqztad5qqrdqqqcqqqqqqqqqqqqqq9gdyq7w0j9pgnd3cnypsvq67lne8lcxzfxda3zlkwtsw8fm8n3pp79lsyxmemdnnhsgev7zuhce44mk3x3naxmwf9ygnnglmw9userg6sq8g9w7n</textarea>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem;">
                                <div>
                                    <label style="color:#ffff00; font-size:0.85rem;">HMAC Import Price ($)</label>
                                    <input type="number" id="admin-hmac-price" value="5" style="width:100%; padding:0.5rem; background:#000; border:2px solid #00ff00; color:#00ff00; border-radius:4px;">
                                </div>
                                <div style="display:flex; align-items:flex-end;">
                                    <button class="btn btn-primary" onclick="savePaymentSettings()" style="width:100%;">üíæ Save Settings</button>
                                </div>
                            </div>
                        </div>
                        <div style="background:#0a0a0a; border:2px solid #00ff00; border-radius:6px; padding:1rem;">
                            <h5 style="color:#00ff00; margin-bottom:0.5rem;">üìä Payment Stats</h5>
                            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:1rem; text-align:center;">
                                <div style="background:#001a00; padding:0.75rem; border-radius:4px;">
                                    <div style="color:#00ff00; font-size:1.5rem; font-weight:700;" id="stat-total-payments">0</div>
                                    <div style="color:#888; font-size:0.75rem;">Total Payments</div>
                                </div>
                                <div style="background:#001a00; padding:0.75rem; border-radius:4px;">
                                    <div style="color:#ffff00; font-size:1.5rem; font-weight:700;" id="stat-total-revenue">$0</div>
                                    <div style="color:#888; font-size:0.75rem;">Revenue</div>
                                </div>
                                <div style="background:#001a00; padding:0.75rem; border-radius:4px;">
                                    <div style="color:#ff9900; font-size:1.5rem; font-weight:700;" id="stat-pending">0</div>
                                    <div style="color:#888; font-size:0.75rem;">Pending</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Log Panel -->
                    <div id="admin-audit" class="admin-section" style="display:none;">
                        <h4 style="color:#00ffff;">üìã Audit Trail</h4>
                        <div style="background:#001a00; border:2px solid #00ffff; border-radius:6px; padding:1rem;">
                            <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                                <input type="text" id="audit-search" placeholder="Search logs..." style="flex:1; padding:0.5rem; background:#000; border:2px solid #00ffff; color:#00ff00; border-radius:4px;">
                                <select id="audit-filter" style="padding:0.5rem; background:#000; border:2px solid #00ffff; color:#00ffff; border-radius:4px;">
                                    <option value="all">All Events</option>
                                    <option value="login">Logins</option>
                                    <option value="payment">Payments</option>
                                    <option value="generate">Generations</option>
                                    <option value="error">Errors</option>
                                </select>
                                <button class="btn" onclick="refreshAuditLog()">üîÑ</button>
                                <button class="btn" onclick="exportAuditLog()">üì• Export</button>
                            </div>
                            <div id="audit-log-list" style="max-height:300px; overflow-y:auto; font-family:monospace; font-size:0.8rem; color:#00ff00;">
                                <div class="audit-entry" style="padding:0.5rem; border-bottom:1px solid #003333;">
                                    <span style="color:#888;">[Loading...]</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Panel -->
                    <div id="admin-users" class="admin-section" style="display:none;">
                        <h4 style="color:#ffff00;">üë• Registered Users</h4>
                        <table id="secure-users-table" style="width:100%; border-collapse:collapse; color:#00ff00; font-size:0.85rem;"></table>
                        <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                            <input id="new-user-email" placeholder="email" style="padding:0.4rem; flex:1; background:#000; border:2px solid #00ff00; color:#00ff00; border-radius:4px;">
                            <input id="new-user-pass" placeholder="password" type="password" style="padding:0.4rem; flex:1; background:#000; border:2px solid #00ff00; color:#00ff00; border-radius:4px;">
                            <button class="btn" id="btn-create-user">‚ûï Create</button>
                        </div>
                    </div>

                    <!-- Balances Panel -->
                    <div id="admin-balances" class="admin-section" style="display:none;">
                        <h4 style="color:#ff00ff;">üí≥ Account Balances & Credits</h4>
                        <div id="secure-balances-list" style="font-family:monospace; color:#00ff00; max-height:200px; overflow-y:auto; background:#001a00; padding:1rem; border-radius:6px; margin-bottom:1rem;"></div>
                        <div style="display:flex; gap:0.5rem;">
                            <input id="credit-email" placeholder="email" style="padding:0.4rem; flex:1; background:#000; border:2px solid #ff00ff; color:#ff00ff; border-radius:4px;">
                            <input id="credit-amount" placeholder="credits" type="number" style="padding:0.4rem; width:80px; background:#000; border:2px solid #ff00ff; color:#ff00ff; border-radius:4px;">
                            <button class="btn" id="btn-credit" style="background:#330033; border-color:#ff00ff; color:#ff00ff;">üí∞ Add Credits</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">üìù EDITABLE FIELDS</div>
            <div id="state-info" class="alert alert-info" style="margin-bottom: 1rem;"></div>
            <div id="field-container"></div>
        </div>
        
        <div class="panel">
            <div class="panel-header">üîß OUTPUT & ANALYSIS</div>
            
            <div id="checksum-comparison-display"></div>
            
            <h3 style="margin-bottom: 0.5rem; color: #ffff00;">Protocol Structure</h3>
            <div class="hex-display" id="protocol-analysis">Awaiting generation...</div>
            
            <h3 style="margin: 1.5rem 0 0.5rem; color: #ffff00;">Binary Hex Dump</h3>
            <div class="hex-display" id="hex-preview">Awaiting generation...</div>
            
            <div id="barcode-output"></div>
        </div>
        
    </div>
    
</main>

<!-- Help Chat Widget -->
<div class="help-widget" id="help-widget">
    <div class="help-toggle" id="help-toggle">
        <img src="assets/logo.png" alt="Help" id="help-avatar">
        <div class="chat-smoke" id="chat-smoke"></div>
    </div>
</div>

<div class="help-panel" id="help-panel">
    <div class="help-panel-header">
        <img src="assets/logo.png" alt="Assistant">
        <span>DO IT RIGHT Assistant</span>
    </div>
    <div class="help-messages" id="help-messages">
        <div class="help-msg bot">üëã Hi! I'm your barcode assistant. Ask me anything about generating compliant barcodes!</div>
    </div>
    <div class="help-input-area">
        <input type="text" id="help-input" placeholder="Type your question...">
        <button id="btn-help-send">Send</button>
    </div>
</div>

<!-- Live Messenger Widget -->
<div class="messenger-widget" id="messenger-widget">
    <div class="messenger-header">
        <span>Live Messenger</span>
        <button onclick="toggleMessenger()" style="background:#333; border:none; color:#00ff00; padding:0.25rem 0.5rem; border-radius:4px; cursor:pointer;">‚úï</button>
    </div>
    <div class="messenger-messages" id="messenger-messages">
        <div class="messenger-message admin">
            Welcome to the Live Messenger! This is a secure admin chat for real-time communication.
        </div>
    </div>
    <div class="messenger-input-area">
        <input type="text" id="messenger-input" placeholder="Type a message...">
        <button onclick="sendMessengerMessage()" style="background:#003300; border:2px solid #00ff00; color:#00ff00; padding:0.5rem 1rem; border-radius:4px; cursor:pointer;">Send</button>
    </div>
</div>

<footer>
    <div style="font-weight: 700; margin-bottom: 0.5rem;">
        DO IT RIGHT RESOURCES - Barcode Generator
    </div>
    <div>
        Multi-State Support | AAMVA Compliant | Secure Generation
    </div>
</footer>

<script>
"use strict";

// ============================================================================
// AUTH SYSTEM - Login/Register with Admin Bypass
// ============================================================================

const ADMIN_EMAIL = 'unkledo@icloud.com';
const ADMIN_PASS = 'Denver3100';
let currentUser = null;
let isAuthMode = 'login'; // 'login' or 'register'
let paymentType = null; // 'barcode' or 'hmac'
let userCredits = 0;

function initAuth() {
    // Check for existing session
    const savedUser = localStorage.getItem('dirUser');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            userCredits = parseInt(localStorage.getItem('dirCredits_' + currentUser.email) || '0');
            hideAuthOverlay();
            updateUserDisplay();
        } catch(e) {
            localStorage.removeItem('dirUser');
        }
    }
    
    // Auth event listeners
    document.getElementById('auth-submit')?.addEventListener('click', handleAuth);
    document.getElementById('auth-toggle')?.addEventListener('click', toggleAuthMode);
    document.getElementById('auth-email')?.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleAuth(); });
    document.getElementById('auth-password')?.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleAuth(); });
    
    // Logout button in header
    document.getElementById('btn-main-logout')?.addEventListener('click', logout);
    
    // Puff smoke on auth logo
    setTimeout(() => puffAuthSmoke(3), 500);
}

function handleAuth() {
    const email = document.getElementById('auth-email')?.value.trim();
    const password = document.getElementById('auth-password')?.value;
    const errorEl = document.getElementById('auth-error');
    
    if (!email || !password) {
        showAuthError('Please enter email and password');
        return;
    }
    
    if (isAuthMode === 'login') {
        doLogin(email, password);
    } else {
        const confirm = document.getElementById('auth-confirm')?.value;
        if (password !== confirm) {
            showAuthError('Passwords do not match');
            return;
        }
        doRegister(email, password);
    }
}

function doLogin(email, password) {
    // Check admin credentials
    if (email === ADMIN_EMAIL && password === ADMIN_PASS) {
        currentUser = { email, isAdmin: true, credits: 999999 };
        userCredits = 999999;
        localStorage.setItem('dirUser', JSON.stringify(currentUser));
        localStorage.setItem('dirCredits_' + email, '999999');
        hideAuthOverlay();
        updateUserDisplay();
        console.log('üîë Admin logged in - unlimited access');
        return;
    }
    
    // Check regular user
    const users = JSON.parse(localStorage.getItem('dirUsers') || '{}');
    if (users[email] && users[email].password === password) {
        currentUser = { email, isAdmin: false };
        userCredits = parseInt(localStorage.getItem('dirCredits_' + email) || '0');
        localStorage.setItem('dirUser', JSON.stringify(currentUser));
        hideAuthOverlay();
        updateUserDisplay();
        console.log('‚úÖ User logged in:', email);
        return;
    }
    
    showAuthError('Invalid email or password');
}

function doRegister(email, password) {
    const users = JSON.parse(localStorage.getItem('dirUsers') || '{}');
    
    if (users[email]) {
        showAuthError('Email already registered');
        return;
    }
    
    users[email] = { password, created: Date.now() };
    localStorage.setItem('dirUsers', JSON.stringify(users));
    localStorage.setItem('dirCredits_' + email, '0');
    
    currentUser = { email, isAdmin: false };
    userCredits = 0;
    localStorage.setItem('dirUser', JSON.stringify(currentUser));
    
    hideAuthOverlay();
    updateUserDisplay();
    console.log('‚úÖ User registered:', email);
}

function showAuthError(msg) {
    const el = document.getElementById('auth-error');
    if (el) {
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }
}

function toggleAuthMode() {
    isAuthMode = isAuthMode === 'login' ? 'register' : 'login';
    const title = document.getElementById('auth-title');
    const btn = document.getElementById('auth-submit');
    const toggle = document.getElementById('auth-toggle');
    const regFields = document.getElementById('register-fields');
    
    if (isAuthMode === 'register') {
        title.textContent = 'Register';
        btn.textContent = 'Register';
        toggle.textContent = 'Already have an account? Login';
        regFields.style.display = 'block';
    } else {
        title.textContent = 'Login';
        btn.textContent = 'Login';
        toggle.textContent = "Don't have an account? Register";
        regFields.style.display = 'none';
    }
    puffAuthSmoke(2);
}

function hideAuthOverlay() {
    const overlay = document.getElementById('auth-overlay');
    if (overlay) {
        overlay.style.display = 'none';
        // Force reflow to ensure the overlay is hidden
        void overlay.offsetWidth;
    }
}

function showAuthOverlay() {
    const overlay = document.getElementById('auth-overlay');
    if (overlay) overlay.style.display = 'flex';
}

function logout() {
    currentUser = null;
    userCredits = 0;
    localStorage.removeItem('dirUser');
    showAuthOverlay();
    updateUserDisplay();
}

function updateUserDisplay() {
    const headerUser = document.getElementById('header-user');
    const emailDisplay = document.getElementById('user-email-display');
    const adminPanel = document.getElementById('secure-panel');
    const isAdmin = currentUser?.isAdmin || false;

    // Force reflow to ensure DOM updates
    void document.body.offsetWidth;

    if (currentUser && headerUser) {
        headerUser.style.display = 'flex';
        if (emailDisplay) {
            emailDisplay.textContent = currentUser.email + (isAdmin ? ' ‚≠ê' : '');
        }
    } else if (headerUser) {
        headerUser.style.display = 'none';
    }

    // Show/hide admin panel
    if (adminPanel) {
        adminPanel.style.display = isAdmin ? 'block' : 'none';
        if (isAdmin) {
            loadAdminData();
        }
    }

    // Log audit event
    if (currentUser) {
        addAuditLog('login', `User logged in: ${currentUser.email}${isAdmin ? ' (ADMIN)' : ''}`);
    }

    console.log('User:', currentUser?.email, 'Credits:', userCredits, 'Admin:', isAdmin);
}

// Admin Panel Functions
function showAdminTab(tabName) {
    // Hide all sections
    document.querySelectorAll('.admin-section').forEach(el => el.style.display = 'none');
    // Remove active from all tabs
    document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
    
    // Show selected section
    const section = document.getElementById('admin-' + tabName);
    if (section) section.style.display = 'block';
    
    // Set active tab
    event.target.classList.add('active');
}

function loadAdminData() {
    loadUsersTable();
    loadBalancesList();
    loadAuditLog();
    loadPaymentStats();
}

function loadUsersTable() {
    const users = JSON.parse(localStorage.getItem('dirUsers') || '{}');
    const table = document.getElementById('secure-users-table');
    if (!table) return;
    
    let html = '<thead><tr style="background:#003300;"><th style="padding:0.5rem; text-align:left;">Email</th><th style="padding:0.5rem;">Credits</th><th style="padding:0.5rem;">Created</th><th style="padding:0.5rem;">Actions</th></tr></thead><tbody>';
    
    Object.entries(users).forEach(([email, data]) => {
        const credits = localStorage.getItem('dirCredits_' + email) || '0';
        const created = data.created ? new Date(data.created).toLocaleDateString() : 'N/A';
        html += `<tr style="border-bottom:1px solid #333;">
            <td style="padding:0.5rem;">${email}</td>
            <td style="padding:0.5rem; text-align:center;">${credits}</td>
            <td style="padding:0.5rem; text-align:center; color:#888;">${created}</td>
            <td style="padding:0.5rem; text-align:center;">
                <button class="btn" style="padding:0.2rem 0.5rem; font-size:0.75rem;" onclick="deleteUser('${email}')">üóëÔ∏è</button>
            </td>
        </tr>`;
    });
    
    html += '</tbody>';
    table.innerHTML = html;
}

function loadBalancesList() {
    const users = JSON.parse(localStorage.getItem('dirUsers') || '{}');
    const list = document.getElementById('secure-balances-list');
    if (!list) return;
    
    let html = '';
    Object.keys(users).forEach(email => {
        const credits = localStorage.getItem('dirCredits_' + email) || '0';
        html += `<div style="padding:0.3rem 0; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
            <span>${email}</span>
            <span style="color:#ffff00;">${credits} credits</span>
        </div>`;
    });
    
    list.innerHTML = html || '<div style="color:#888;">No users found</div>';
}

function loadPaymentStats() {
    const payments = JSON.parse(localStorage.getItem('dirPayments') || '[]');
    const totalPayments = payments.length;
    const totalRevenue = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
    const pending = payments.filter(p => p.status === 'pending').length;
    
    document.getElementById('stat-total-payments').textContent = totalPayments;
    document.getElementById('stat-total-revenue').textContent = '$' + totalRevenue;
    document.getElementById('stat-pending').textContent = pending;
}

// Audit Log Functions
let auditLog = [];

function addAuditLog(type, message) {
    const entry = {
        time: new Date().toISOString(),
        type: type,
        message: message,
        user: currentUser?.email || 'anonymous'
    };
    auditLog.unshift(entry);
    
    // Store in localStorage
    const stored = JSON.parse(localStorage.getItem('dirAuditLog') || '[]');
    stored.unshift(entry);
    if (stored.length > 500) stored.pop(); // Keep last 500 entries
    localStorage.setItem('dirAuditLog', JSON.stringify(stored));
}

function loadAuditLog() {
    auditLog = JSON.parse(localStorage.getItem('dirAuditLog') || '[]');
    refreshAuditLog();
}

function refreshAuditLog() {
    const list = document.getElementById('audit-log-list');
    const filter = document.getElementById('audit-filter')?.value || 'all';
    const search = document.getElementById('audit-search')?.value?.toLowerCase() || '';
    
    if (!list) return;
    
    let filtered = auditLog;
    if (filter !== 'all') {
        filtered = filtered.filter(e => e.type === filter);
    }
    if (search) {
        filtered = filtered.filter(e => e.message.toLowerCase().includes(search) || e.user.toLowerCase().includes(search));
    }
    
    if (filtered.length === 0) {
        list.innerHTML = '<div class="audit-entry"><span style="color:#888;">No entries found</span></div>';
        return;
    }
    
    list.innerHTML = filtered.slice(0, 100).map(entry => {
        const time = new Date(entry.time).toLocaleString();
        return `<div class="audit-entry">
            <span class="audit-time">${time}</span>
            <span class="audit-type ${entry.type}">${entry.type.toUpperCase()}</span>
            <span>${entry.message}</span>
            <span style="color:#666; float:right;">${entry.user}</span>
        </div>`;
    }).join('');
}

function exportAuditLog() {
    const data = JSON.stringify(auditLog, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'audit-log-' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function savePaymentSettings() {
    const settings = {
        btcAddress: document.getElementById('admin-btc-address')?.value || '',
        lnInvoice: document.getElementById('admin-ln-invoice')?.value || '',
        barcodePrice: parseFloat(document.getElementById('admin-barcode-price')?.value) || 10,
        hmacPrice: parseFloat(document.getElementById('admin-hmac-price')?.value) || 5
    };
    localStorage.setItem('dirPaymentSettings', JSON.stringify(settings));
    addAuditLog('payment', 'Payment settings updated by admin');
    alert('‚úÖ Payment settings saved!');
}

function deleteUser(email) {
    if (!confirm(`Delete user ${email}?`)) return;
    const users = JSON.parse(localStorage.getItem('dirUsers') || '{}');
    delete users[email];
    localStorage.setItem('dirUsers', JSON.stringify(users));
    localStorage.removeItem('dirCredits_' + email);
    addAuditLog('admin', `User deleted: ${email}`);
    loadUsersTable();
    loadBalancesList();
}

function isAdminUser() {
    return currentUser?.isAdmin === true;
}

function hasCredits() {
    return isAdminUser() || userCredits > 0;
}

// Auth logo smoke effect
function puffAuthSmoke(count = 2) {
    const container = document.getElementById('auth-logo-smoke');
    if (!container) return;
    for (let i = 0; i < count; i++) {
        setTimeout(() => {
            const leftPuff = document.createElement('div');
            leftPuff.className = 'smoke-puff left';
            leftPuff.style.animationDelay = (Math.random() * 0.3) + 's';
            container.appendChild(leftPuff);
            setTimeout(() => leftPuff.remove(), 2500);
            
            const rightPuff = document.createElement('div');
            rightPuff.className = 'smoke-puff right';
            rightPuff.style.animationDelay = (Math.random() * 0.3) + 's';
            container.appendChild(rightPuff);
            setTimeout(() => rightPuff.remove(), 2500);
        }, i * 200);
    }
}

/**
 * Visual Reward: Printing Animation (Dot Matrix Style)
 */
function triggerPrintingAnimation() {
    const printer = document.createElement('div');
    printer.className = 'panel';
    printer.style.position = 'fixed';
    printer.style.top = '50%';
    printer.style.left = '50%';
    printer.style.transform = 'translate(-50%, -50%)';
    printer.style.width = '300px';
    printer.style.zIndex = '100005';
    printer.style.padding = '2rem';
    printer.style.border = '1px solid var(--neon-green)';
    printer.style.boxShadow = '0 0 100px rgba(0,255,136,0.3)';
    
    printer.innerHTML = `
        <div style="font-family:monospace; color:var(--neon-green); font-size:0.7rem; line-height:1; white-space:pre;">
.-------------------.
|  DOT MATRIX 3000  |
|  STATUS: PRINTING |
'-------------------'
        </div>
        <div id="printer-lines" style="margin-top:1rem; font-size:0.6rem; color:var(--neon-green); height:60px; overflow:hidden;"></div>
        <div style="width: 100%; height: 2px; background: var(--glass-heavy); margin-top:1rem; position: relative; overflow:hidden;">
            <div id="printer-head" style="position: absolute; width: 10px; height: 100%; background: #fff; box-shadow: 0 0 10px #fff;"></div>
        </div>
    `;
    
    document.body.appendChild(printer);
    
    const lines = [
        "> INITIALIZING HEAD...",
        "> FEEDING PAPER...",
        "> BUFFERING DATA...",
        "> RENDER::PNG_ALPHA",
        "> CRC_OK::0x29B1",
        "> LINE_FEED_01",
        "> PRINT_COMPLETE"
    ];
    
    let lineIdx = 0;
    const lineInterval = setInterval(() => {
        if (lineIdx < lines.length) {
            const l = document.createElement('div');
            l.textContent = lines[lineIdx];
            document.getElementById('printer-lines').appendChild(l);
            lineIdx++;
        }
    }, 200);

    const head = document.getElementById('printer-head');
    head.animate([
        { left: '0%' }, { left: '90%' }, { left: '0%' }
    ], { duration: 400, iterations: Infinity });
    
    setTimeout(() => {
        clearInterval(lineInterval);
        printer.animate([{ opacity: 1, scale: 1 }, { opacity: 0, scale: 0.9 }], { duration: 300, fill: 'forwards' }).onfinish = () => printer.remove();
    }, 1800);
}

/**
 * Visual Reward: Field Completion Pulse
 */
function pulseField(id) {
    const el = document.getElementById('fld-' + id);
    if (!el) return;
    
    // Add satisfying pulse reward
    el.animate([
        { borderColor: 'var(--neon-green)', boxShadow: '0 0 0 0 transparent' },
        { borderColor: '#fff', boxShadow: '0 0 20px 5px var(--neon-green-glow)' },
        { borderColor: 'var(--neon-green)', boxShadow: '0 0 0 0 transparent' }
    ], { duration: 400, easing: 'ease-out' });

    // Visual reward: Temporary success indicator
    const row = el.closest('.field-row');
    const badge = row.querySelector('.badge');
    if (badge && !badge.dataset.original) {
        badge.dataset.original = badge.textContent;
        badge.dataset.originalClass = badge.className;
        
        badge.innerHTML = '‚úì SAVED';
        badge.className = 'badge alert-success';
        badge.style.boxShadow = '0 0 15px var(--neon-green)';
        
        setTimeout(() => {
            badge.textContent = badge.dataset.original;
            badge.className = badge.dataset.originalClass;
            badge.style.boxShadow = '';
            delete badge.dataset.original;
        }, 1200);
    }
}

// ============================================================================
// BARCODE GENERATION
// ============================================================================

function showPaymentTab(tab) {
    document.getElementById('payment-btc').style.display = tab === 'btc' ? 'block' : 'none';
    document.getElementById('payment-ln').style.display = tab === 'ln' ? 'block' : 'none';
    document.getElementById('tab-btc').classList.toggle('active', tab === 'btc');
    document.getElementById('tab-ln').classList.toggle('active', tab === 'ln');
}

function showPaymentModal(type) {
    // Admin bypass - no payment needed
    if (isAdminUser()) {
        console.log('üîë Admin bypass - no payment required');
        if (type === 'hmac') {
            onImportHMACKeyConfirmed();
        }
        return true; // Payment not needed
    }
    
    paymentType = type;
    const modal = document.getElementById('payment-modal');
    const typeDisplay = document.getElementById('payment-type-display');
    const amountDisplay = document.getElementById('payment-amount-display');
    
    if (type === 'barcode') {
        typeDisplay.textContent = 'Barcode Generation - $10';
        amountDisplay.textContent = '$10.00 USD';
    } else if (type === 'hmac') {
        typeDisplay.textContent = 'HMAC Key Import - $5';
        amountDisplay.textContent = '$5.00 USD';
    }
    
    modal.classList.add('active');
    return false; // Payment needed
}

function closePaymentModal() {
    document.getElementById('payment-modal')?.classList.remove('active');
    paymentType = null;
}

function simulatePayment() {
    // For demo/testing - mark as paid
    if (paymentType === 'barcode') {
        userCredits += 1;
        localStorage.setItem('dirCredits_' + currentUser?.email, userCredits.toString());
        alert('‚úÖ Payment confirmed! You can now generate 1 barcode.');
    } else if (paymentType === 'hmac') {
        alert('‚úÖ Payment confirmed! HMAC key import unlocked.');
        onImportHMACKeyConfirmed();
    }
    closePaymentModal();
}

// Called after payment confirmed for HMAC import
async function onImportHMACKeyConfirmed() {
    const hex = document.getElementById('hmac-key-hex')?.value.trim();
    if (!hex) { 
        alert('Enter hex key to import'); 
        return; 
    }
    const ok = await importHMACKeyHex(hex);
    if (ok) {
        alert('‚úÖ HMAC key imported successfully!');
        document.getElementById('enable-hmac').checked = true;
        onHMACToggle();
    } else {
        alert('Failed to import HMAC key');
    }
}

// ============================================================================
// MD5 IMPLEMENTATION (Educational - DO NOT USE IN PRODUCTION)
// ============================================================================

function md5(message) {
    // UTF-8 encode
    const bytes = new TextEncoder().encode(message || '');

    // Helper functions
    const rotl = (x, n) => (x << n) | (x >>> (32 - n));
    const toHexLE = (num) => {
        return ('00000000' + (num >>> 0).toString(16)).slice(-8).match(/../g).reverse().join('');
    };

    // Initialize vars
    let a0 = 0x67452301;
    let b0 = 0xEFCDAB89;
    let c0 = 0x98BADCFE;
    let d0 = 0x10325476;

    // Pre-processing: padding
    const origLenBits = bytes.length * 8;
    const padLen = ((56 - (bytes.length + 1) % 64) + 64) % 64; // bytes to pad after 0x80
    const totalLen = bytes.length + 1 + padLen + 8;
    const buf = new Uint8Array(totalLen);
    buf.set(bytes, 0);
    buf[bytes.length] = 0x80;
    // length in bits, little-endian 64-bit
    for (let i = 0; i < 8; i++) {
        buf[bytes.length + 1 + padLen + i] = (origLenBits >>> (8 * i)) & 0xFF;
    }

    // Constants T
    const K = new Uint32Array(64);
    for (let i = 0; i < 64; i++) K[i] = Math.floor(Math.abs(Math.sin(i + 1)) * 0x100000000) >>> 0;

    // per-round shifts
    const s = [7,12,17,22, 5,9,14,20, 4,11,16,23, 6,10,15,21];

    // Process each 512-bit chunk
    for (let offset = 0; offset < buf.length; offset += 64) {
        const M = new Uint32Array(16);
        for (let i = 0; i < 16; i++) {
            M[i] = (
                (buf[offset + i*4 + 0]) |
                (buf[offset + i*4 + 1] << 8) |
                (buf[offset + i*4 + 2] << 16) |
                (buf[offset + i*4 + 3] << 24)
            ) >>> 0;
        }

        let A = a0, B = b0, C = c0, D = d0;

        for (let i = 0; i < 64; i++) {
            let F, g;
            if (i < 16) {
                F = (B & C) | ((~B) & D);
                g = i;
            } else if (i < 32) {
                F = (D & B) | ((~D) & C);
                g = (5*i + 1) % 16;
            } else if (i < 48) {
                F = B ^ C ^ D;
                g = (3*i + 5) % 16;
            } else {
                F = C ^ (B | (~D));
                g = (7*i) % 16;
            }
            const tmp = (A + F + K[i] + M[g]) >>> 0;
            const rot = (i < 16) ? s[(i % 4)] : (i < 32 ? s[(4 + (i % 4))] : (i < 48 ? s[(8 + (i % 4))] : s[(12 + (i % 4))]));
            A = D;
            D = C;
            C = B;
            B = (B + rotl(tmp, rot)) >>> 0;
        }

        a0 = (a0 + A) >>> 0;
        b0 = (b0 + B) >>> 0;
        c0 = (c0 + C) >>> 0;
        d0 = (d0 + D) >>> 0;
    }

    // produce the final hash (little-endian)
    return toHexLE(a0) + toHexLE(b0) + toHexLE(c0) + toHexLE(d0);
}

// ============================================================================
// AES-256 ENCRYPTION (Web Crypto API - FIPS 197 Compliant)
// ============================================================================
//
// COMPLIANCE NOTES:
// - FIPS 197 (Advanced Encryption Standard) compliant implementation
// - Uses AES-256-GCM (Galois/Counter Mode) per NIST SP 800-38D
// - 256-bit key length (32 bytes) as required by FIPS 197
// - 96-bit IV (12 bytes) as recommended by NIST for GCM mode
// - 128-bit authentication tag for data integrity
// - All cryptographic operations use Web Crypto API (browser native)
//
// PII ENCRYPTION:
// The following fields are encrypted when AES is enabled:
// - DCS (Last Name), DAC (First Name), DAD (Middle Name) - Name data
// - DBB (Date of Birth) - Birth date
// - DAG (Address), DAI (City) - Location data
// - DAQ (DL Number), DCF (Document Discriminator) - ID numbers
//
// COMPLIANCE STANDARDS:
// - FIPS 197: Advanced Encryption Standard (AES)
// - NIST SP 800-38D: Recommendation for GCM mode
// - AAMVA D20: Driver License/ID Card Specification
//

let aesKey = null;
let aesKeyHex = '';

// Secure in-memory key storage (cleared on page unload)
const encryptionKeyStore = new Map();

/**
 * FIPS 197 Compliance Check
 * Verifies that the AES implementation meets federal standards
 * @returns {Object} Compliance status report
 */
function checkAESCompliance() {
    return {
        standard: 'FIPS 197',
        algorithm: 'AES-256-GCM',
        keySize: 256,
        keySizeBytes: 32,
        ivSize: 96,
        ivSizeBytes: 12,
        authTagSize: 128,
        authTagSizeBytes: 16,
        mode: 'GCM (Galois/Counter Mode)',
        nistReference: 'SP 800-38D',
        complianceStatus: 'COMPLIANT',
        notes: [
            'Uses Web Crypto API (browser native implementation)',
            '256-bit keys generated via cryptographically secure RNG',
            '96-bit IV per NIST GCM recommendations',
            '128-bit authentication tag for integrity verification'
        ]
    };
}

async function generateAESKey() {
    aesKey = await crypto.subtle.generateKey(
        { name: "AES-GCM", length: 256 },
        true,
        ["encrypt", "decrypt"]
    );
    
    const exported = await crypto.subtle.exportKey("raw", aesKey);
    const hexArray = Array.from(new Uint8Array(exported));
    aesKeyHex = hexArray.map(b => b.toString(16).padStart(2, '0')).join('');
    
    console.log('üîë AES-256 Key Generated:', aesKeyHex);
    
    const display = document.getElementById('aes-key-display');
    if (display) {
        display.textContent = aesKeyHex;
    }
}

async function encryptFieldAES(data) {
    if (!aesKey) {
        await generateAESKey();
    }
    
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data);
    
    const encrypted = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv: iv },
        aesKey,
        dataBuffer
    );
    
    const encryptedArray = new Uint8Array(encrypted);
    const combined = new Uint8Array(iv.length + encryptedArray.length);
    combined.set(iv);
    combined.set(encryptedArray, iv.length);
    
    // Convert to hex with proper invisible layer markers
    // Using AAMVA-compliant invisible layer format: [0x1F][encrypted_hex][0x1F]
    const hexData = Array.from(combined).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
    return '\x1F' + hexData + '\x1F';
}

async function decryptFieldAES(hexData) {
    if (!aesKey) {
        throw new Error('No AES key available');
    }
    
    const combined = new Uint8Array(hexData.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
    const iv = combined.slice(0, 12);
    const encrypted = combined.slice(12);
    
    const decrypted = await crypto.subtle.decrypt(
        { name: "AES-GCM", iv: iv },
        aesKey,
        encrypted
    );
    
    const decoder = new TextDecoder();
    return decoder.decode(decrypted);
}

// Fields that should be encrypted (sensitive data)
const SENSITIVE_FIELDS = ['DCS', 'DAC', 'DAD', 'DBB', 'DAG', 'DAH', 'DAI'];

// ============================================================================
// STATE-SPECIFIC CONFIGURATIONS
// ============================================================================

const STATE_CONFIGS = {
    FL: {
        name: "Florida",
        iin: "636026",
        subfileId: "ZF",
        auditTrail: "FLDMVAUDIT000001",
        useIdemia: true,
        defaultYear: 2020,
        revisionDate: "03/01/2020",
        exampleData: {
            DAQ: "B231952418000",
            DCS: "BOLDEN",
            DAC: "JACOB",
            DAD: "WALTER",
            DBB: "01011990",
            DBA: "01012032",
            DBD: "03012020",
            DDB: "03012020",
            DBC: "1",
            DAY: "BRO",
            DAU: "070 IN",
            DAW: "180",
            DAZ: "BRO",
            DAG: "605 AFFIRMED COURT",
            DAI: "TALLAHASSEE",
            DAJ: "FL",
            DAK: "323990000",
            DCG: "USA",
            DCA: "E",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "E802009203873",
            DDA: "M",
            DDE: "N",
            DDF: "N",
            DDG: "N",
            DDK: "1"
        }
     },
CA: {
        name: "California",
        iin: "636014",
        subfileId: "ZC",
        auditTrail: "CADMVAUDIT000001",
        useIdemia: false,
        defaultYear: 2017,
        revisionDate: "08/29/2017",
        exampleData: {
            DAQ: "I1234568",
            DCS: "SAMPLE",
            DDE: "N",
            DAC: "JANE",
            DDF: "N",
            DAD: "MARIE",
            DDG: "N",
            DCA: "C",
            DCB: "NONE",
            DCD: "NONE",
            DBD: "01012017",
            DBB: "01011985",
            DBA: "01012028",
            DBC: "2",
            DAU: "070 IN",
            DAY: "BRN",
            DAG: "7772 DIXIE LOU ST",
            DAI: "SACRAMENTO",
            DAJ: "CA",
            DAK: "958164035",
            DCG: "USA",
            DCF: "AB1234567890",
            DAW: "140",
            DAZ: "BRN",
            DCK: "123456",
            DDA: "Y",
            DDB: "08292017",
            DDK: "1"
        }
     },
    TX: {
        name: "Texas",
        iin: "636015",
        subfileId: "ZT",
        auditTrail: "TXDPSAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "12345678",
            DCS: "SMITH",
            DAC: "JOHN",
            DAD: "WILLIAM",
            DBB: "05151988",
            DBA: "05152028",
            DBD: "05152023",
            DDB: "05152023",
            DBC: "1",
            DAY: "BRO",
            DAU: "072 IN",
            DAW: "185",
            DAZ: "BLK",
            DAG: "123 MAIN STREET",
            DAI: "HOUSTON",
            DAJ: "TX",
            DAK: "770011234",
            DCG: "USA",
            DCA: "C",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "TX123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    NY: {
        name: "New York",
        iin: "636001",
        subfileId: "ZN",
        auditTrail: "NYDMVAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "123456789",
            DCS: "JOHNSON",
            DAC: "MICHAEL",
            DAD: "JAMES",
            DBB: "03201985",
            DBA: "03202028",
            DBD: "03202023",
            DDB: "03202023",
            DBC: "1",
            DAY: "BLU",
            DAU: "070 IN",
            DAW: "175",
            DAZ: "BRO",
            DAG: "456 BROADWAY",
            DAI: "NEW YORK",
            DAJ: "NY",
            DAK: "100011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "NY123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    GA: {
        name: "Georgia",
        iin: "636055",
        subfileId: "ZG",
        auditTrail: "GADDSAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "123456789",
            DCS: "WILLIAMS",
            DAC: "DAVID",
            DAD: "LEE",
            DBB: "07041990",
            DBA: "07042030",
            DBD: "07042025",
            DDB: "07042025",
            DBC: "1",
            DAY: "BRO",
            DAU: "071 IN",
            DAW: "180",
            DAZ: "BLK",
            DAG: "789 PEACHTREE ST",
            DAI: "ATLANTA",
            DAJ: "GA",
            DAK: "303011234",
            DCG: "USA",
            DCA: "C",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "GA123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    NC: {
        name: "North Carolina",
        iin: "636004",
        subfileId: "ZN",
        auditTrail: "NCDMVAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "123456789012",
            DCS: "BROWN",
            DAC: "ROBERT",
            DAD: "ALLEN",
            DBB: "09151987",
            DBA: "09152027",
            DBD: "09152022",
            DDB: "09152022",
            DBC: "1",
            DAY: "GRN",
            DAU: "069 IN",
            DAW: "170",
            DAZ: "BRO",
            DAG: "321 OAK DRIVE",
            DAI: "CHARLOTTE",
            DAJ: "NC",
            DAK: "282011234",
            DCG: "USA",
            DCA: "C",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "NC123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    PA: {
        name: "Pennsylvania",
        iin: "636025",
        subfileId: "ZP",
        auditTrail: "PADOTAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        revisionDate: "01/01/2020",
        exampleData: {
            DAQ: "12345678",
            DCS: "DAVIS",
            DAC: "THOMAS",
            DAD: "EDWARD",
            DBB: "02281986",
            DBA: "02282030",
            DBD: "02282025",
            DDB: "02282025",
            DBC: "1",
            DAY: "BRO",
            DAU: "071 IN",
            DAW: "175",
            DAZ: "BRO",
            DAG: "123 LIBERTY AVE",
            DAI: "PHILADELPHIA",
            DAJ: "PA",
            DAK: "191011234",
            DCG: "USA",
            DCA: "C",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "PA123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    OH: {
        name: "Ohio",
        iin: "636023",
        subfileId: "ZO",
        auditTrail: "OHBMVAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        revisionDate: "01/01/2020",
        exampleData: {
            DAQ: "AB123456",
            DCS: "WILSON",
            DAC: "JAMES",
            DAD: "ROBERT",
            DBB: "06151987",
            DBA: "06152031",
            DBD: "06152026",
            DDB: "06152026",
            DBC: "1",
            DAY: "BLU",
            DAU: "072 IN",
            DAW: "180",
            DAZ: "BRO",
            DAG: "456 BUCKEYE BLVD",
            DAI: "COLUMBUS",
            DAJ: "OH",
            DAK: "432011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "OH123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    IL: {
        name: "Illinois",
        iin: "636035",
        subfileId: "ZI",
        auditTrail: "ILSOSAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        revisionDate: "01/01/2020",
        exampleData: {
            DAQ: "M12345678901",
            DCS: "MARTINEZ",
            DAC: "CARLOS",
            DAD: "ANTONIO",
            DBB: "11201988",
            DBA: "11202028",
            DBD: "11202024",
            DDB: "11202024",
            DBC: "1",
            DAY: "BRO",
            DAU: "068 IN",
            DAW: "165",
            DAZ: "BLK",
            DAG: "789 MICHIGAN AVE",
            DAI: "CHICAGO",
            DAJ: "IL",
            DAK: "606011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "IL123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    AZ: {
        name: "Arizona",
        iin: "636039",
        subfileId: "ZA",
        auditTrail: "AZMVDAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "D12345678",
            DCS: "MOORE",
            DAC: "DANIEL",
            DAD: "SCOTT",
            DBB: "12251989",
            DBA: "12252065",
            DBD: "12252020",
            DDB: "12252020",
            DBC: "1",
            DAY: "BRO",
            DAU: "071 IN",
            DAW: "175",
            DAZ: "BRO",
            DAG: "123 DESERT RD",
            DAI: "PHOENIX",
            DAJ: "AZ",
            DAK: "850011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "AZ123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    NV: {
        name: "Nevada",
        iin: "636049",
        subfileId: "ZV",
        auditTrail: "NVDMVAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "1234567890",
            DCS: "TAYLOR",
            DAC: "KEVIN",
            DAD: "MARK",
            DBB: "08081991",
            DBA: "08082029",
            DBD: "08082025",
            DDB: "08082025",
            DBC: "1",
            DAY: "GRN",
            DAU: "070 IN",
            DAW: "170",
            DAZ: "BRO",
            DAG: "456 STRIP BLVD",
            DAI: "LAS VEGAS",
            DAJ: "NV",
            DAK: "891011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "NV123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    CO: {
        name: "Colorado",
        iin: "636020",
        subfileId: "ZC",
        auditTrail: "CODMVAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "123456789",
            DCS: "ANDERSON",
            DAC: "BRIAN",
            DAD: "JOSEPH",
            DBB: "04151988",
            DBA: "04152028",
            DBD: "04152024",
            DDB: "04152024",
            DBC: "1",
            DAY: "BLU",
            DAU: "072 IN",
            DAW: "180",
            DAZ: "BLN",
            DAG: "789 MOUNTAIN VIEW",
            DAI: "DENVER",
            DAJ: "CO",
            DAK: "802011234",
            DCG: "USA",
            DCA: "R",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "CO123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    WA: {
        name: "Washington",
        iin: "636045",
        subfileId: "ZW",
        auditTrail: "WADOLAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "THOMABC123AB",
            DCS: "THOMAS",
            DAC: "STEVEN",
            DAD: "RAY",
            DBB: "01301986",
            DBA: "01302030",
            DBD: "01302025",
            DDB: "01302025",
            DBC: "1",
            DAY: "GRY",
            DAU: "069 IN",
            DAW: "165",
            DAZ: "GRY",
            DAG: "321 PIKE PLACE",
            DAI: "SEATTLE",
            DAJ: "WA",
            DAK: "981011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "WA123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    NJ: {
        name: "New Jersey",
        iin: "636036",
        subfileId: "ZJ",
        auditTrail: "NJMVCAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "A12345678901234",
            DCS: "JACKSON",
            DAC: "ANTHONY",
            DAD: "WAYNE",
            DBB: "10101985",
            DBA: "10102029",
            DBD: "10102025",
            DDB: "10102025",
            DBC: "1",
            DAY: "BRO",
            DAU: "071 IN",
            DAW: "175",
            DAZ: "BLK",
            DAG: "456 JERSEY AVE",
            DAI: "NEWARK",
            DAJ: "NJ",
            DAK: "071011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "NJ123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    VA: {
        name: "Virginia",
        iin: "636000",
        subfileId: "ZV",
        auditTrail: "VADMVAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "T12345678",
            DCS: "WHITE",
            DAC: "RICHARD",
            DAD: "ALAN",
            DBB: "05051987",
            DBA: "05052031",
            DBD: "05052026",
            DDB: "05052026",
            DBC: "1",
            DAY: "BLU",
            DAU: "073 IN",
            DAW: "185",
            DAZ: "BRO",
            DAG: "789 COLONIAL PKWY",
            DAI: "RICHMOND",
            DAJ: "VA",
            DAK: "232011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "VA123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    MI: {
        name: "Michigan",
        iin: "636032",
        subfileId: "ZM",
        auditTrail: "MISOSAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "K123456789012",
            DCS: "HARRIS",
            DAC: "CHARLES",
            DAD: "DEAN",
            DBB: "07201984",
            DBA: "07202028",
            DBD: "07202024",
            DDB: "07202024",
            DBC: "1",
            DAY: "HAZ",
            DAU: "070 IN",
            DAW: "170",
            DAZ: "BRO",
            DAG: "555 MOTOR CITY DR",
            DAI: "DETROIT",
            DAJ: "MI",
            DAK: "482011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "MI123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    TN: {
        name: "Tennessee",
        iin: "636053",
        subfileId: "ZT",
        auditTrail: "TNDOSAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "123456789",
            DCS: "MARTIN",
            DAC: "GARY",
            DAD: "LEE",
            DBB: "03151990",
            DBA: "03152030",
            DBD: "03152025",
            DDB: "03152025",
            DBC: "1",
            DAY: "BRO",
            DAU: "068 IN",
            DAW: "160",
            DAZ: "BLK",
            DAG: "123 MUSIC ROW",
            DAI: "NASHVILLE",
            DAJ: "TN",
            DAK: "372011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "TN123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    MD: {
        name: "Maryland",
        iin: "636003",
        subfileId: "ZM",
        auditTrail: "MDMVAAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "M123456789012",
            DCS: "THOMPSON",
            DAC: "LARRY",
            DAD: "WAYNE",
            DBB: "09091988",
            DBA: "09092028",
            DBD: "09092024",
            DDB: "09092024",
            DBC: "1",
            DAY: "BRO",
            DAU: "069 IN",
            DAW: "165",
            DAZ: "BLK",
            DAG: "456 HARBOR BLVD",
            DAI: "BALTIMORE",
            DAJ: "MD",
            DAK: "212011234",
            DCG: "USA",
            DCA: "C",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "MD123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    MA: {
        name: "Massachusetts",
        iin: "636002",
        subfileId: "ZM",
        auditTrail: "MARMVAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "S12345678",
            DCS: "GARCIA",
            DAC: "MANUEL",
            DAD: "JOSE",
            DBB: "11111986",
            DBA: "11112030",
            DBD: "11112025",
            DDB: "11112025",
            DBC: "1",
            DAY: "BRO",
            DAU: "067 IN",
            DAW: "155",
            DAZ: "BLK",
            DAG: "789 BEACON ST",
            DAI: "BOSTON",
            DAJ: "MA",
            DAK: "021011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "MA123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    },
    IN: {
        name: "Indiana",
        iin: "636037",
        subfileId: "ZI",
        auditTrail: "INBMVAUDIT000001",
        useIdemia: false,
        defaultYear: 2020,
        exampleData: {
            DAQ: "1234567890",
            DCS: "ROBINSON",
            DAC: "ERIC",
            DAD: "ALLEN",
            DBB: "06061989",
            DBA: "06062029",
            DBD: "06062025",
            DDB: "06062025",
            DBC: "1",
            DAY: "GRN",
            DAU: "072 IN",
            DAW: "180",
            DAZ: "BRO",
            DAG: "321 SPEEDWAY BLVD",
            DAI: "INDIANAPOLIS",
            DAJ: "IN",
            DAK: "462011234",
            DCG: "USA",
            DCA: "D",
            DCB: "NONE",
            DCD: "NONE",
            DCF: "IN123456789012",
            DDA: "F",
            DDE: "N",
            DDF: "N",
            DDG: "N"
        }
    }
};

const FIELD_SCHEMA = [
    {id:"DAQ", label:"DL Number", include:{FL:'required', CA:'required'}, desc:"DL/ID Number"},
    {id:"DCS", label:"Last Name", include:{FL:'required', CA:'required'}, desc:"Last Name", sensitive:true},
    {id:"DDE", label:"Last Name Truncated", include:{FL:'always', CA:'always'}, desc:"Y/N"},
    {id:"DAC", label:"First Name", include:{FL:'required', CA:'required'}, desc:"First Name", sensitive:true},
    {id:"DDF", label:"First Name Truncated", include:{FL:'always', CA:'always'}, desc:"Y/N"},
    {id:"DAD", label:"Middle Name", include:{FL:'optional', CA:'optional'}, desc:"Middle Name", sensitive:true},
    {id:"DDG", label:"Middle Name Truncated", include:{FL:'always', CA:'always'}, desc:"Y/N"},
    {id:"DCA", label:"License Class", include:{FL:'required', CA:'required'}, desc:"License Class: C"},
    {id:"DCB", label:"Restrictions", include:{FL:'always', CA:'always'}, desc:"Restriction: NONE/A"},
    {id:"DCD", label:"Endorsements", include:{FL:'always', CA:'always'}, desc:"Endorsement: NONE"},
    {id:"DBD", label:"Issue Date", include:{FL:'required', CA:'required'}, desc:"Issue Date"},
    {id:"DBB", label:"Date of Birth", include:{FL:'required', CA:'required'}, desc:"Date of Birthday", sensitive:true},
    {id:"DBA", label:"Expiration Date", include:{FL:'required', CA:'required'}, desc:"Exp Date"},
    {id:"DBC", label:"Sex", include:{FL:'required', CA:'required'}, desc:"Sex: 1-Male/2-Female"},
    {id:"DAU", label:"Height", include:{FL:'required', CA:'required'}, desc:"Height: 070 IN"},
    {id:"DAY", label:"Eye Color", include:{FL:'required', CA:'required'}, desc:"Eye Color"},
    {id:"DAG", label:"Address", include:{FL:'required', CA:'required'}, desc:"Address", sensitive:true},
    {id:"DAI", label:"City", include:{FL:'required', CA:'required'}, desc:"City", sensitive:true},
    {id:"DAJ", label:"State", include:{FL:'required', CA:'required'}, desc:"State"},
    {id:"DAK", label:"ZIP Code", include:{FL:'required', CA:'required'}, desc:"ZIP 5+0000"},
    {id:"DCF", label:"DD #", include:{FL:'required', CA:'required'}, desc:"Doc Discriminator"},
    {id:"DCG", label:"Country", include:{FL:'required', CA:'required'}, desc:"Country (USA)", readOnly: true},
    {id:"DAW", label:"Weight", include:{FL:'optional', CA:'optional'}, desc:"Weight Pounds"},
    {id:"DAZ", label:"Hair Color", include:{FL:'optional', CA:'optional'}, desc:"Hair Color: BRO/BLN/BLK"},
    {id:"DCK", label:"Inventory #", include:{FL:'optional', CA:'optional'}, desc:"Inventory #"},
    {id:"DDA", label:"Real ID", include:{FL:'optional', CA:'always'}, desc:"Real ID: Y/N"},
    {id:"DDB", label:"Revision Date", include:{FL:'optional', CA:'always'}, desc:"Revision Date: 08292017"},
    {id:"DDK", label:"Organ Donor", include:{FL:'optional', CA:'always'}, desc:"Organ Donor (1)", readOnly: true},
    {id:"DDH", label:"Under 18 Until", include:{FL:'optional', CA:'optional'}, desc:"MMDDYYYY"},
    {id:"DDI", label:"Under 19 Until", include:{FL:'optional', CA:'optional'}, desc:"MMDDYYYY"},
    {id:"DDJ", label:"Under 21 Until", include:{FL:'optional', CA:'optional'}, desc:"MMDDYYYY"},
    {id:"DDL", label:"Veteran", include:{FL:'optional', CA:'optional'}, desc:"Y if veteran"},
    {id:"DCE", label:"Weight Range", include:{FL:'optional', CA:'optional'}, desc:"0-9 range code"},
    {id:"DCL", label:"Race/Ethnicity", include:{FL:'optional', CA:'optional'}, desc:"Race Code"},
    {id:"DCU", label:"Suffix", include:{FL:'optional', CA:'optional'}, desc:"JR/SR/III/IV"},
    {id:"DCT", label:"Given Name Alt", include:{FL:'optional', CA:'optional'}, desc:"First Name (Alt)"},
    {id:"DDD", label:"Limited Duration", include:{FL:'optional', CA:'optional'}, desc:"Y if temp"},
    {id:"DDC", label:"HazMat Exp Date", include:{FL:'optional', CA:'optional'}, desc:"MMDDYYYY"},
    {id:"PAA", label:"Permit Class", include:{FL:'optional', CA:'optional'}, desc:"Permit Class"},
    {id:"PAB", label:"Permit Exp Date", include:{FL:'optional', CA:'optional'}, desc:"Permit Exp Date"},
    {id:"PAC", label:"Permit Issue Date", include:{FL:'optional', CA:'optional'}, desc:"Permit Issue Date"},
    {id:"PAD", label:"Permit ID", include:{FL:'optional', CA:'optional'}, desc:"Permit ID"},
    {id:"PAE", label:"Permit Endorsements", include:{FL:'optional', CA:'optional'}, desc:"Permit End"},
    {id:"PAF", label:"Permit Restrictions", include:{FL:'optional', CA:'optional'}, desc:"Permit Rest"},
    {id:"DBO", label:"Last Name Alias", include:{FL:'optional', CA:'optional'}, desc:"Alias Surname"},
    {id:"DBP", label:"First Name Alias", include:{FL:'optional', CA:'optional'}, desc:"Alias Given"},
    {id:"DBQ", label:"Middle Name Alias", include:{FL:'optional', CA:'optional'}, desc:"Alias Middle"},
    {id:"DBR", label:"Suffix Alias", include:{FL:'optional', CA:'optional'}, desc:"Alias Suffix"},
    {id:"DBS", label:"Name Prefix", include:{FL:'optional', CA:'optional'}, desc:"MR/MRS/MS/DR"},
    {id:"DBN", label:"Alias Family Name", include:{FL:'optional', CA:'optional'}, desc:"Alias Last"},
    {id:"DCH", label:"Federal Commercial", include:{FL:'optional', CA:'optional'}, desc:"Federal Limits"},
    {id:"DCI", label:"Jurisdiction Vehicle", include:{FL:'optional', CA:'optional'}, desc:"Jur Vehicle"},
    {id:"DCJ", label:"Jurisdiction Rest", include:{FL:'optional', CA:'optional'}, desc:"Jur Rest"},
    {id:"DCM", label:"Standard Vehicle", include:{FL:'optional', CA:'optional'}, desc:"Standard Class"},
    {id:"DCN", label:"Standard Endorsement", include:{FL:'optional', CA:'optional'}, desc:"Standard End"},
    {id:"DCO", label:"Standard Restriction", include:{FL:'optional', CA:'optional'}, desc:"Standard Rest"},
    {id:"DCP", label:"Country ID", include:{FL:'optional', CA:'optional'}, desc:"Country Tertiary"},
    {id:"DCQ", label:"Audit Info", include:{FL:'optional', CA:'optional'}, desc:"Audit Data"},
    {id:"DCR", label:"Compliance Flag", include:{FL:'optional', CA:'optional'}, desc:"Compliance"}
];

const FL_SUBFILE = [
    {id:"ZFA", label:"FL Class", include:'required', desc:"Florida Class", defaultVal: "E"},
    {id:"ZFB", label:"FL Exp Date", include:'required', desc:"Florida Expiration", defaultVal: ""},
    {id:"ZFC", label:"FL DL Number", include:'required', desc:"Florida License #", defaultVal: ""},
    {id:"ZFD", label:"FL Office", include:'optional', desc:"Issuing Office", defaultVal: ""},
    {id:"ZFE", label:"FL Compliance", include:'optional', desc:"Compliance Data", defaultVal: ""},
    {id:"ZFJ", label:"FL Reserved", include:'optional', desc:"Reserved Field", defaultVal: ""},
    {id:"ZFK", label:"FL Terminator", include:'optional', desc:"End Marker", defaultVal: "X"}
];
const CA_SUBFILE = [
    {id:"ZCA", label:"ZCA - Eye Color", include:'required', desc:"Eye Color (BRN/BLU/GRN)", defaultVal: "BRN"},
    {id:"ZCB", label:"ZCB - Hair Color", include:'required', desc:"Hair Color (BRN/BLN/BLK)", defaultVal: "BRN"},
    {id:"ZCC", label:"ZCC - Empty Field", include:'always', desc:"Empty data field (always included)", defaultVal: ""},
    {id:"ZCD", label:"ZCD - Empty Field", include:'always', desc:"Empty data field (always included)", defaultVal: ""}
];

// All State Z Subfile Schemas
const STATE_SUBFILES = {
    FL: FL_SUBFILE,
    CA: CA_SUBFILE,
    TX: [
        {id:"ZTA", label:"TX Class", include:'required', desc:"Texas Class", defaultVal: "C"},
        {id:"ZTB", label:"TX CDL Status", include:'required', desc:"CDL Status", defaultVal: ""},
        {id:"ZTC", label:"TX Audit Number", include:'required', desc:"TX Audit #", defaultVal: ""},
        {id:"ZTD", label:"TX Inv Control", include:'always', desc:"Inventory Control", defaultVal: ""},
        {id:"ZTE", label:"TX Endorsements", include:'optional', desc:"Endorsements", defaultVal: "NONE"},
        {id:"ZTF", label:"TX Restrictions", include:'optional', desc:"Restrictions", defaultVal: "NONE"},
        {id:"ZTG", label:"TX REAL ID", include:'required', desc:"REAL ID Compliant", defaultVal: "Y"}
    ],
    NY: [
        {id:"ZNA", label:"NY Class", include:'required', desc:"New York Class", defaultVal: "D"},
        {id:"ZNB", label:"NY Doc Type", include:'required', desc:"Document Type", defaultVal: "1"},
        {id:"ZNC", label:"NY ID Number", include:'required', desc:"NY ID #", defaultVal: ""},
        {id:"ZND", label:"NY Issue Date", include:'always', desc:"Issue Date", defaultVal: ""},
        {id:"ZNE", label:"NY Organ Donor", include:'optional', desc:"Organ Donor", defaultVal: "N"},
        {id:"ZNF", label:"NY Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZNG", label:"NY Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZNH", label:"NY REAL ID", include:'required', desc:"REAL ID Flag", defaultVal: "Y"}
    ],
    GA: [
        {id:"ZGA", label:"GA Class", include:'required', desc:"Georgia Class", defaultVal: "C"},
        {id:"ZGB", label:"GA Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZGC", label:"GA Customer #", include:'required', desc:"Customer Number", defaultVal: ""},
        {id:"ZGD", label:"GA Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZGE", label:"GA Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZGF", label:"GA Compliance", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    NC: [
        {id:"ZNA", label:"NC Class", include:'required', desc:"North Carolina Class", defaultVal: "C"},
        {id:"ZNB", label:"NC Version", include:'required', desc:"Version Code", defaultVal: "01"},
        {id:"ZNC", label:"NC Audit #", include:'required', desc:"Audit Number", defaultVal: ""},
        {id:"ZND", label:"NC Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZNE", label:"NC Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZNF", label:"NC REAL ID", include:'required', desc:"REAL ID Compliant", defaultVal: "Y"}
    ],
    PA: [
        {id:"ZPA", label:"PA Class", include:'required', desc:"Pennsylvania Class", defaultVal: "C"},
        {id:"ZPB", label:"PA Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZPC", label:"PA Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZPD", label:"PA Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZPE", label:"PA Organ Donor", include:'optional', desc:"Organ Donor", defaultVal: "N"},
        {id:"ZPF", label:"PA Veteran", include:'optional', desc:"Veteran Flag", defaultVal: "N"},
        {id:"ZPG", label:"PA REAL ID", include:'required', desc:"REAL ID Compliant", defaultVal: "Y"}
    ],
    OH: [
        {id:"ZOA", label:"OH Class", include:'required', desc:"Ohio Class", defaultVal: "D"},
        {id:"ZOB", label:"OH Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZOC", label:"OH Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZOD", label:"OH Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZOE", label:"OH Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZOF", label:"OH Donor", include:'optional', desc:"Organ Donor", defaultVal: "N"},
        {id:"ZOG", label:"OH Compliance", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    IL: [
        {id:"ZIA", label:"IL Class", include:'required', desc:"Illinois Class", defaultVal: "D"},
        {id:"ZIB", label:"IL Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZIC", label:"IL Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZID", label:"IL Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZIE", label:"IL Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZIF", label:"IL Organ Donor", include:'optional', desc:"Organ Donor", defaultVal: "N"},
        {id:"ZIG", label:"IL REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    AZ: [
        {id:"ZAA", label:"AZ Class", include:'required', desc:"Arizona Class", defaultVal: "D"},
        {id:"ZAB", label:"AZ Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZAC", label:"AZ Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZAD", label:"AZ Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZAE", label:"AZ Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZAF", label:"AZ Compliance", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    NV: [
        {id:"ZVA", label:"NV Class", include:'required', desc:"Nevada Class", defaultVal: "D"},
        {id:"ZVB", label:"NV Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZVC", label:"NV Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZVD", label:"NV Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZVE", label:"NV Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZVF", label:"NV REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    CO: [
        {id:"ZCA", label:"CO Class", include:'required', desc:"Colorado Class", defaultVal: "R"},
        {id:"ZCB", label:"CO Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZCC", label:"CO Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZCD", label:"CO Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZCE", label:"CO Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZCF", label:"CO REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    WA: [
        {id:"ZWA", label:"WA Class", include:'required', desc:"Washington Class", defaultVal: "D"},
        {id:"ZWB", label:"WA Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZWC", label:"WA Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZWD", label:"WA Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZWE", label:"WA Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZWF", label:"WA EDL Flag", include:'optional', desc:"Enhanced DL", defaultVal: "N"},
        {id:"ZWG", label:"WA REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    NJ: [
        {id:"ZJA", label:"NJ Class", include:'required', desc:"New Jersey Class", defaultVal: "D"},
        {id:"ZJB", label:"NJ Doc Type", include:'required', desc:"Document Type", defaultVal: ""},
        {id:"ZJC", label:"NJ Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZJD", label:"NJ Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZJE", label:"NJ Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZJF", label:"NJ Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZJG", label:"NJ REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    VA: [
        {id:"ZVA", label:"VA Class", include:'required', desc:"Virginia Class", defaultVal: "D"},
        {id:"ZVB", label:"VA Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZVC", label:"VA Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZVD", label:"VA Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZVE", label:"VA Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZVF", label:"VA Veteran", include:'optional', desc:"Veteran Flag", defaultVal: "N"},
        {id:"ZVG", label:"VA REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    MI: [
        {id:"ZMA", label:"MI Class", include:'required', desc:"Michigan Class", defaultVal: "O"},
        {id:"ZMB", label:"MI Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZMC", label:"MI Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZMD", label:"MI Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZME", label:"MI Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZMF", label:"MI Organ Donor", include:'optional', desc:"Organ Donor", defaultVal: "N"},
        {id:"ZMG", label:"MI REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    TN: [
        {id:"ZTA", label:"TN Class", include:'required', desc:"Tennessee Class", defaultVal: "D"},
        {id:"ZTB", label:"TN Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZTC", label:"TN Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZTD", label:"TN Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZTE", label:"TN Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZTF", label:"TN REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    MD: [
        {id:"ZMA", label:"MD Class", include:'required', desc:"Maryland Class", defaultVal: "C"},
        {id:"ZMB", label:"MD Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZMC", label:"MD Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZMD", label:"MD Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZME", label:"MD Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZMF", label:"MD Veteran", include:'optional', desc:"Veteran Flag", defaultVal: "N"},
        {id:"ZMG", label:"MD REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    MA: [
        {id:"ZMA", label:"MA Class", include:'required', desc:"Massachusetts Class", defaultVal: "D"},
        {id:"ZMB", label:"MA Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZMC", label:"MA Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZMD", label:"MA Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZME", label:"MA Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZMF", label:"MA REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ],
    IN: [
        {id:"ZIA", label:"IN Class", include:'required', desc:"Indiana Class", defaultVal: "O"},
        {id:"ZIB", label:"IN Control #", include:'required', desc:"Control Number", defaultVal: ""},
        {id:"ZIC", label:"IN Issue Date", include:'required', desc:"Issue Date", defaultVal: ""},
        {id:"ZID", label:"IN Restrictions", include:'optional', desc:"Restrictions", defaultVal: ""},
        {id:"ZIE", label:"IN Endorsements", include:'optional', desc:"Endorsements", defaultVal: ""},
        {id:"ZIF", label:"IN Organ Donor", include:'optional', desc:"Organ Donor", defaultVal: "N"},
        {id:"ZIG", label:"IN REAL ID", include:'required', desc:"REAL ID", defaultVal: "Y"}
    ]
};

// Helper function to get Z subfile for current state
function getStateSubfile(state) {
    return STATE_SUBFILES[state] || FL_SUBFILE;
}

// ============================================================================
// CRC-16-CCITT IMPLEMENTATION
// ============================================================================

function crc16ccitt(data) {
    let crc = 0xFFFF;
    const poly = 0x1021;
    
    for (let i = 0; i < data.length; i++) {
        const byte = typeof data[i] === 'string' ? data.charCodeAt(i) : data[i];
        crc ^= (byte << 8);
        
        for (let bit = 0; bit < 8; bit++) {
            if (crc & 0x8000) {
                crc = ((crc << 1) ^ poly) & 0xFFFF;
            } else {
                crc = (crc << 1) & 0xFFFF;
            }
        }
    }
    
    return crc;
}

// ============================================================================
// BINARY UTILITIES
// ============================================================================

function stringToBytes(str) {
    const bytes = [];
    for (let i = 0; i < str.length; i++) {
        bytes.push(str.charCodeAt(i));
    }
    return bytes;
}

function bytesToHex(bytes, withSpaces = true) {
    const hex = Array.from(bytes).map(b => 
        b.toString(16).toUpperCase().padStart(2, '0')
    );
    return withSpaces ? hex.join(' ') : hex.join('');
}

// ============================================================================
// STATE MANAGEMENT
// ============================================================================

let currentState = 'FL';
let currentAAMVA = '09';
let currentJurisdiction = '01';
let aesEnabled = false;
let md5Enabled = false; // user toggle for MD5 (non-admin)
let md5AdminAllowed = false; // admin permission flag
let adminMode = false; // whether admin is unlocked in UI
const ADMIN_TOKEN = '3100-31-3100';
const ADMIN_API_PATH = '/admin/control';

// Admin API key reference (stored locally)
let adminApiKey = localStorage.getItem('adminApiKey') || '';
function setAdminApiKey(key) {
    adminApiKey = key || '';
    if (adminApiKey) localStorage.setItem('adminApiKey', adminApiKey);
    else localStorage.removeItem('adminApiKey');
    const input = document.getElementById('admin-api-key-input');
    if (input) input.value = adminApiKey;
    console.log('Admin API key set');
}

// Simple in-memory MD5 cache to avoid recomputing the same digest multiple times
const md5Cache = new Map();
function md5Cached(s) {
    if (md5Cache.has(s)) return md5Cache.get(s);
    const h = md5(s);
    md5Cache.set(s, h);
    return h;
}

// HMAC-SHA256 state and helpers
let hmacEnabled = false; // toggle to sign payload
let hmacKey = null; // CryptoKey
let hmacKeyHex = '';

function bufferToHex(buf) {
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
}
function hexToBytes(hex) {
    if (!hex) return new Uint8Array();
    const arr = hex.match(/.{1,2}/g) || [];
    return new Uint8Array(arr.map(b => parseInt(b, 16)));
}

async function generateHMACKey() {
    hmacKey = await crypto.subtle.generateKey({ name: 'HMAC', hash: 'SHA-256' }, true, ['sign', 'verify']);
    const raw = await crypto.subtle.exportKey('raw', hmacKey);
    hmacKeyHex = bufferToHex(raw);
    document.getElementById('hmac-key-hex').value = hmacKeyHex;
    document.getElementById('hmac-key-id').textContent = hmacKeyHex.substring(0, 16) + '...';
    console.log('üîë HMAC key generated:', hmacKeyHex.substring(0, 32) + '...');
}

async function importHMACKeyHex(hex) {
    try {
        const bytes = hexToBytes(hex);
        hmacKey = await crypto.subtle.importKey('raw', bytes, { name: 'HMAC', hash: 'SHA-256' }, true, ['sign', 'verify']);
        hmacKeyHex = hex.toUpperCase();
        document.getElementById('hmac-key-hex').value = hmacKeyHex;
        document.getElementById('hmac-key-id').textContent = hmacKeyHex.substring(0, 16) + '...';
        console.log('üîë HMAC key imported');
        return true;
    } catch (e) {
        console.error('Failed to import HMAC key', e);
        return false;
    }
}

async function signHMACHex(dataStr) {
    if (!hmacKey) throw new Error('No HMAC key loaded');
    const data = new TextEncoder().encode(dataStr);
    const sig = await crypto.subtle.sign('HMAC', hmacKey, data);
    return bufferToHex(sig);
}

async function verifyHMACHex(hexSig, dataStr) {
    if (!hmacKey) throw new Error('No HMAC key loaded');
    const sigBytes = hexToBytes(hexSig);
    const data = new TextEncoder().encode(dataStr);
    // re-sign and compare
    const expected = await crypto.subtle.sign('HMAC', hmacKey, data);
    const expHex = bufferToHex(expected);
    return expHex === hexSig.toUpperCase();
}

function getCurrentConfig() {
    return STATE_CONFIGS[currentState];
}

function updateConfigDisplay() {
    const display = document.getElementById('config-display');
    if (display) {
        const text = `${currentState} AAMVA v${currentAAMVA} Jur v${currentJurisdiction}`;
        display.textContent = text;
        display.className = 'state-indicator ghost-text';
        display.setAttribute('data-text', text);
    }
    
    const stateInfo = document.getElementById('state-info');
    const config = getCurrentConfig();
    if (stateInfo) {
        let cryptoInfo = '';
        if (aesEnabled) cryptoInfo += '<span class="status-indicator status-crypto"></span><strong>AES-256 ACTIVE</strong> ';
        if (md5Enabled) cryptoInfo += '<span class="status-indicator status-crypto"></span><strong>MD5 ACTIVE</strong> ';
        if (hmacEnabled) cryptoInfo += '<span class="status-indicator status-crypto"></span><strong>HMAC-SHA256 ACTIVE</strong> ';
        if (adminMode) cryptoInfo += '<br><span class="status-indicator status-crypto"></span><strong>ADMIN MODE</strong> ';
        
        // Get current inventory number from input
        const inventoryInput = document.getElementById('inventory-number');
        const inventoryNum = inventoryInput ? inventoryInput.value.trim() : config.auditTrail;
        
        stateInfo.innerHTML = `
            <strong>üìç ${config.name} Configuration Active</strong><br>
            IIN: ${config.iin} | 
            Subfile: ${config.subfileId} | 
            ${config.useIdemia ? 'IDEMIA Protocol' : 'DMV Standard'} | 
            Inventory#: <span style="color:#ffff00;">${inventoryNum}</span>
            ${cryptoInfo ? '<br>' + cryptoInfo : ''}
        `;
    }
}

// -------------------------------
// Admin UI helpers & API calls
// -------------------------------

function setAdminMode(enabled, email) {
    adminMode = !!enabled;
    const actions = document.getElementById('admin-actions');
    const loginArea = document.getElementById('admin-login-area');
    const statusArea = document.getElementById('admin-status-area');
    const emailDisplay = document.getElementById('admin-email-display');
    const loginBtn = document.getElementById('btn-admin-login');
    const logoutBtn = document.getElementById('btn-admin-logout');

    if (adminMode) {
        if (actions) actions.style.display = '';
        if (loginArea) loginArea.style.display = 'none';
        if (statusArea) statusArea.style.display = '';
        if (emailDisplay) emailDisplay.textContent = email || 'admin';
        if (loginBtn) loginBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = '';
    } else {
        if (actions) actions.style.display = 'none';
        if (loginArea) loginArea.style.display = '';
        if (statusArea) statusArea.style.display = 'none';
        if (emailDisplay) emailDisplay.textContent = '';
        if (loginBtn) loginBtn.style.display = '';
        if (logoutBtn) logoutBtn.style.display = 'none';
    }

    updateConfigDisplay();
}

async function adminLogin() {
    try {
        const email = document.getElementById('admin-email').value.trim();
        const password = document.getElementById('admin-password').value;
        const isHuman = document.getElementById('admin-human').checked;

        if (!email || !password || !isHuman) {
            alert('Enter email, password and confirm you are human');
            return;
        }

        const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }), credentials: 'include' });
        const data = await res.json();
        if (!res.ok) {
            alert('Login failed: ' + (data.error || data.message || JSON.stringify(data)));
            return;
        }

        setAdminMode(true, email);
        alert('‚úÖ Admin logged in');
    } catch (e) {
        console.error('Admin login error', e);
        alert('Admin login error: ' + e.message);
    }
}

async function adminLogout() {
    try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
    } catch (e) {
        console.warn('Logout request failed', e);
    }
    setAdminMode(false);
    alert('Logged out');
}

function showAdminSection(name) {
    ['admin-users', 'admin-logs', 'admin-balances', 'admin-chat'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = (id === name) ? '' : 'none';
    });
}

async function loadAdminUsers() {
    try {
        showAdminSection('admin-users');
        const res = await fetch('/api/admin/users', { method: 'GET', credentials: 'include' });
        const users = await res.json();
        const table = document.getElementById('admin-users-table');
        if (!table) return;
        table.innerHTML = '<tr><th>Email</th><th>Role</th><th>Created</th></tr>' + users.map(u => `<tr><td>${u.email}</td><td>${u.role||'user'}</td><td>${u.createdAt||''}</td></tr>`).join('');
    } catch (e) {
        console.error('Load users error', e);
        alert('Failed to load users');
    }
}

async function createUser() {
    const email = document.getElementById('new-user-email')?.value.trim();
    const password = document.getElementById('new-user-pass')?.value;
    
    if (!email || !password) { 
        alert('Please enter email and password'); 
        return; 
    }
    
    const users = JSON.parse(localStorage.getItem('dirUsers') || '{}');
    
    if (users[email]) {
        alert('User already exists: ' + email);
        return;
    }
    
    users[email] = { password, created: Date.now() };
    localStorage.setItem('dirUsers', JSON.stringify(users));
    localStorage.setItem('dirCredits_' + email, '0');
    
    addAuditLog('admin', `Admin created user: ${email}`);
    alert('‚úÖ User created: ' + email);
    
    loadUsersTable();
    loadBalancesList();
    
    // Clear inputs
    document.getElementById('new-user-email').value = '';
    document.getElementById('new-user-pass').value = '';
}

async function loadAdminLogs() {
    try {
        showAdminSection('admin-logs');
        const res = await fetch('/api/admin/logs?limit=200', { credentials: 'include' });
        const logs = await res.json();
        const list = document.getElementById('admin-logs-list');
        if (!list) return;
        list.innerHTML = logs.map(l => `<div>[${l.timestamp}] ${l.action} - ${l.details} (${l.ip})</div>`).join('');
    } catch (e) { console.error(e); alert('Failed to load logs'); }
}

async function loadBalances() {
    try {
        showAdminSection('admin-balances');
        const res = await fetch('/api/admin/balances', { credentials: 'include' });
        const json = await res.json();
        const list = document.getElementById('admin-balances-list');
        if (!list) return;
        list.innerHTML = Object.entries(json || {}).map(([k,v]) => `<div><strong>${k}</strong>: ${v}</div>`).join('');
    } catch (e) { console.error(e); alert('Failed to load balances'); }
}

async function creditAccount() {
    const email = document.getElementById('credit-email')?.value.trim();
    const amount = parseInt(document.getElementById('credit-amount')?.value);
    
    if (!email || isNaN(amount) || amount <= 0) { 
        alert('Please enter a valid email and credit amount'); 
        return; 
    }
    
    // Check if user exists
    const users = JSON.parse(localStorage.getItem('dirUsers') || '{}');
    if (!users[email]) {
        alert('User not found: ' + email);
        return;
    }
    
    // Add credits
    const currentCredits = parseInt(localStorage.getItem('dirCredits_' + email) || '0');
    const newCredits = currentCredits + amount;
    localStorage.setItem('dirCredits_' + email, newCredits.toString());
    
    // Log it
    addAuditLog('payment', `Admin credited ${amount} credits to ${email} (Total: ${newCredits})`);
    
    alert(`‚úÖ Added ${amount} credits to ${email}\nNew balance: ${newCredits} credits`);
    
    // Refresh displays
    loadBalancesList();
    loadUsersTable();
    
    // Clear inputs
    document.getElementById('credit-email').value = '';
    document.getElementById('credit-amount').value = '';
}

async function loadChat() {
    try {
        showAdminSection('admin-chat');
        const res = await fetch('/api/chat/history', { credentials: 'include' });
        const msgs = await res.json();
        const h = document.getElementById('chat-history');
        if (!h) return;
        h.innerHTML = msgs.map(m => `<div><strong>${m.user||'bot'}:</strong> ${m.text}</div>`).join('');
    } catch (e) { console.error(e); alert('Failed to load chat'); }
}

async function sendChatMessage() {
    try {
        const text = document.getElementById('chat-input').value.trim();
        if (!text) return;
        const res = await fetch('/api/chat/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ text }) });
        const json = await res.json();
        if (!res.ok) { alert('Send failed: ' + (json.error || JSON.stringify(json))); return; }
        document.getElementById('chat-input').value = '';
        loadChat();
        // animate assistant
        const avatar = document.getElementById('bot-avatar');
        if (avatar) { avatar.classList.add('bounce'); setTimeout(() => avatar.classList.remove('bounce'), 300); }
        puffHeaderSmoke(2);
    } catch (e) { console.error(e); alert('Send failed'); }
}

// ------------ Interactive Logo & Smoke from Feet ------------

// Create smoke puffs from feet of header logo
function puffHeaderSmoke(count = 4) {
    const container = document.getElementById('logo-smoke');
    if (!container) return;
    
    for (let i = 0; i < count; i++) {
        // Left foot smoke
        const leftPuff = document.createElement('div');
        leftPuff.className = 'smoke-puff left';
        leftPuff.style.animationDelay = (Math.random() * 0.3) + 's';
        leftPuff.style.left = (12 + Math.random() * 10) + 'px';
        container.appendChild(leftPuff);
        leftPuff.addEventListener('animationend', () => leftPuff.remove());
        
        // Right foot smoke
        const rightPuff = document.createElement('div');
        rightPuff.className = 'smoke-puff right';
        rightPuff.style.animationDelay = (Math.random() * 0.3 + 0.1) + 's';
        rightPuff.style.left = (42 + Math.random() * 10) + 'px';
        container.appendChild(rightPuff);
        rightPuff.addEventListener('animationend', () => rightPuff.remove());
    }
}

// Create smoke puffs from feet of chat widget logo
function puffChatSmoke(count = 3) {
    const container = document.getElementById('chat-smoke');
    if (!container) return;
    
    for (let i = 0; i < count; i++) {
        // Left foot smoke
        const leftPuff = document.createElement('div');
        leftPuff.className = 'smoke-puff left';
        leftPuff.style.animationDelay = (Math.random() * 0.25) + 's';
        leftPuff.style.left = (15 + Math.random() * 8) + 'px';
        container.appendChild(leftPuff);
        leftPuff.addEventListener('animationend', () => leftPuff.remove());
        
        // Right foot smoke
        const rightPuff = document.createElement('div');
        rightPuff.className = 'smoke-puff right';
        rightPuff.style.animationDelay = (Math.random() * 0.25 + 0.1) + 's';
        rightPuff.style.left = (47 + Math.random() * 8) + 'px';
        container.appendChild(rightPuff);
        rightPuff.addEventListener('animationend', () => rightPuff.remove());
    }
}

// Header logo click - bounce and smoke from feet
document.getElementById('page-logo')?.addEventListener('click', () => {
    const el = document.getElementById('page-logo');
    if (!el) return;
    el.classList.remove('bounce');
    void el.offsetWidth; // Trigger reflow
    el.classList.add('bounce');
    setTimeout(() => el.classList.remove('bounce'), 500);
    puffHeaderSmoke(5);
});

// Header logo hover - subtle smoke
document.getElementById('page-logo')?.addEventListener('mouseenter', () => {
    puffHeaderSmoke(2);
});

// Chat widget toggle click - bounce and smoke from feet
document.getElementById('help-toggle')?.addEventListener('click', () => {
    const toggle = document.getElementById('help-toggle');
    const panel = document.getElementById('help-panel');
    
    if (toggle) {
        toggle.classList.remove('bounce');
        void toggle.offsetWidth;
        toggle.classList.add('bounce');
        setTimeout(() => toggle.classList.remove('bounce'), 600);
    }
    
    puffChatSmoke(4);
    
    if (panel) {
        panel.classList.toggle('active');
    }
});

// Chat widget hover - subtle smoke
document.getElementById('help-toggle')?.addEventListener('mouseenter', () => {
    puffChatSmoke(2);
});

// Auto smoke on chat send
document.getElementById('btn-help-send')?.addEventListener('click', () => {
    const input = document.getElementById('help-input');
    const msgs = document.getElementById('help-messages');
    const text = input?.value?.trim();
    if (!text) return;
    
    // Add user message
    const userMsg = document.createElement('div');
    userMsg.className = 'help-msg user';
    userMsg.textContent = text;
    msgs.appendChild(userMsg);
    input.value = '';
    
    // Smoke effect
    puffChatSmoke(3);
    
    // Bot response after delay
    setTimeout(() => {
        const botMsg = document.createElement('div');
        botMsg.className = 'help-msg bot';
        
        // Simple responses based on keywords
        const lowerText = text.toLowerCase();
        let response = "I can help you generate barcodes! Try selecting a state and clicking 'Generate Barcode'.";
        
        if (lowerText.includes('generate') || lowerText.includes('barcode')) {
            response = "To generate a barcode: 1) Select your state, 2) Fill in the required fields (yellow), 3) Click 'Generate Barcode'. The inventory number is appended to the data before encoding.";
        } else if (lowerText.includes('state')) {
            response = "We support 20+ states including FL, CA, TX, NY, GA, NC, PA, OH, IL, AZ, NV, CO, WA, NJ, VA, MI, TN, MD, MA, and IN. Each has its own IIN and field requirements.";
        } else if (lowerText.includes('inventory') || lowerText.includes('audit')) {
            response = "The Inventory Number (Audit Trail) is a 16-character code appended after the ZF fields close and CRC checksum. It's editable in the Configuration section.";
        } else if (lowerText.includes('encrypt') || lowerText.includes('aes')) {
            response = "AES-256 encryption can be enabled in the Cryptography section. It encrypts sensitive fields like name, DOB, and address while maintaining barcode structure.";
        } else if (lowerText.includes('pay') || lowerText.includes('bitcoin') || lowerText.includes('btc')) {
            response = "Payment is $10 per session via Bitcoin. Click 'Generate Barcode' and follow the payment prompts to unlock unlimited generation.";
        } else if (lowerText.includes('help') || lowerText.includes('how')) {
            response = "I'm here to help! Ask me about: generating barcodes, state selection, inventory numbers, encryption, or payment.";
        }
        
        botMsg.textContent = response;
        msgs.appendChild(botMsg);
        msgs.scrollTop = msgs.scrollHeight;
        puffChatSmoke(2);
    }, 800);
});

// Enter key to send in help chat
document.getElementById('help-input')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('btn-help-send')?.click();
    }
});

// Toggle messenger widget
function toggleMessenger() {
    const widget = document.getElementById('messenger-widget');
    if (widget) {
        widget.classList.toggle('active');
    }
}

// Send messenger message
function sendMessengerMessage() {
    const input = document.getElementById('messenger-input');
    const msgs = document.getElementById('messenger-messages');
    const text = input?.value?.trim();
    if (!text) return;
    
    const userMsg = document.createElement('div');
    userMsg.className = 'messenger-message user';
    userMsg.textContent = text;
    msgs.appendChild(userMsg);
    input.value = '';
    msgs.scrollTop = msgs.scrollHeight;
}

// Fallback for missing logo (use embedded SVG with figure)
document.getElementById('page-logo')?.addEventListener('error', (e) => {
    const el = e && e.target ? e.target : document.getElementById('page-logo');
    if (!el) return;
    console.warn('Logo missing, using fallback');
    el.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" viewBox="0 0 72 72"><rect width="100%" height="100%" fill="#0a0a0a" rx="8"/><circle cx="36" cy="20" r="14" fill="#00ff00"/><rect x="26" y="34" width="20" height="24" fill="#00ff00" rx="3"/><rect x="24" y="58" width="8" height="10" fill="#00ff00" rx="2"/><rect x="40" y="58" width="8" height="10" fill="#00ff00" rx="2"/><circle cx="32" cy="18" r="3" fill="#000"/><circle cx="40" cy="18" r="3" fill="#000"/></svg>');
});

// Fallback for help avatar
document.getElementById('help-avatar')?.addEventListener('error', (e) => {
    const el = e && e.target ? e.target : document.getElementById('help-avatar');
    if (!el) return;
    el.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60"><rect width="100%" height="100%" fill="#0a0a0a" rx="8"/><circle cx="30" cy="18" r="12" fill="#00ff00"/><rect x="20" y="30" width="20" height="18" fill="#00ff00" rx="3"/><rect x="18" y="48" width="8" height="8" fill="#00ff00" rx="2"/><rect x="34" y="48" width="8" height="8" fill="#00ff00" rx="2"/><circle cx="26" cy="16" r="2.5" fill="#000"/><circle cx="34" cy="16" r="2.5" fill="#000"/></svg>');
});

// ============================================================================
// DMV COMPLIANT PAYLOAD BUILDER WITH ENCRYPTION
// ============================================================================

async function buildDMVCompliantPayload() {
    const LF = '\x0A';
    const CR = '\x0D';
    const RS = '\x1E';
    const EOT = '\x04';
    const FS = '\x1C'; // File Separator - for invisible layer structure
    const GS = '\x1D'; // Group Separator - for field separation in invisible layer
    const US = '\x1F'; // Unit Separator - already used for field encapsulation
    
    const config = getCurrentConfig();
    
    console.log(`üîß Building ${config.name} payload...`);
    console.log(`üîê AES-256: ${aesEnabled ? 'ENABLED' : 'DISABLED'}`);
    console.log(`üîê MD5: ${md5Enabled ? 'ENABLED' : 'DISABLED'}`);
    
    // Build DL subfile with visible fields only
    let dlBody = '';
    let includedFields = 0;
    let omittedFields = 0;
    let encryptedCount = 0;
    let invisibleLayer = ''; // Storage for encrypted fields
    
    for (const field of FIELD_SCHEMA) {
        const input = document.getElementById('fld-' + field.id);
        let value = input ? input.value.trim() : '';
        const includeRule = field.include ? (field.include[currentState] || field.include['FL'] || 'optional') : 'optional';
        
        // Encrypt sensitive fields if AES is enabled
        if (aesEnabled && value && field.sensitive) {
            console.log(`üîê Encrypting ${field.id}: "${value}"`);
            const encryptedValue = await encryptFieldAES(value);
            invisibleLayer += field.id + GS + encryptedValue + FS; // Store in invisible layer
            encryptedCount++;
            console.log(`   ‚Üí Encrypted: ${encryptedValue.substring(0, 40)}...`);
        } else if (value || includeRule === 'always') {
            // Add visible fields to DL subfile
            dlBody += field.id + value + LF;
            includedFields++;
        } else {
            omittedFields++;
        }
    }
    
    console.log(`DL Subfile: ${includedFields} included, ${omittedFields} omitted, ${encryptedCount} encrypted`);
    
    // Build state-specific subfile using the proper state schema
    const subfileSchema = getStateSubfile(currentState);
    const subfileId = config.subfileId;
    
    let stateBody = '';
    let stateIncluded = 0;
    
    subfileSchema.forEach(field => {
        const input = document.getElementById('fld-' + field.id);
        let value = input ? input.value.trim() : '';
        
        if (!value && field.defaultVal) {
            value = field.defaultVal;
        }
        
        const includeRule = field.include;
        const shouldInclude = includeRule === 'required' || includeRule === 'always' || value.length > 0;
        
        if (shouldInclude) {
            stateBody += field.id + value + LF;
            stateIncluded++;
        }
    });
    
    console.log(`${subfileId} Subfile: ${stateIncluded} fields included`);
    
    // Build header
    const PREAMBLE = '@' + LF + RS + CR;
    const IIN = config.iin;
    const AAMVA_VER = currentAAMVA;
    const JUR_VER = currentJurisdiction;
    const ENTRIES = '02';
    
    let header = 'ANSI ' + IIN + AAMVA_VER + JUR_VER + ENTRIES;
    
    // Calculate offsets
    const PREAMBLE_LEN = 4;
    const DESIGNATOR_LEN = 20;
    const HEADER_BASE = header.length;
    
    const DL_OFFSET = PREAMBLE_LEN + HEADER_BASE + DESIGNATOR_LEN + 1;
    const DL_LENGTH = 2 + 1 + dlBody.length + 1;
    const STATE_OFFSET = DL_OFFSET + DL_LENGTH;
    const STATE_LENGTH = 2 + 1 + stateBody.length + 1;
    
    // Build designator
    const designator = 
        'DL' + String(DL_OFFSET).padStart(4, '0') + String(DL_LENGTH).padStart(4, '0') +
        subfileId + String(STATE_OFFSET).padStart(4, '0') + String(STATE_LENGTH).padStart(4, '0');
    
    header += designator + LF;
    
    // Assemble visible payload
    const visiblePayload = PREAMBLE + header + 'DL' + LF + dlBody + CR + subfileId + LF + stateBody + CR + RS + EOT;
    
    // Calculate checksums - only include visible content (exclude invisible layer)
    const startTime = performance.now();
    const crc = crc16ccitt(visiblePayload);
    const crcTime = performance.now() - startTime;
    
    let md5Hash = null;
    let md5Time = 0;
    
    if (md5Enabled) {
        const md5StartTime = performance.now();
        md5Hash = md5Cached(visiblePayload);
        md5Time = performance.now() - md5StartTime;
        console.log(`üìä MD5: ${md5Hash} (${md5Time.toFixed(3)}ms)`);
    }
    
    console.log(`üìä CRC-16: 0x${crc.toString(16).toUpperCase()} (${crcTime.toFixed(3)}ms)`);
    
    // Assemble complete payload with visible content first
    let payload = visiblePayload;
    
    // Add invisible layer if there are encrypted fields
    let invisibleLayerPos = -1;
    if (aesEnabled && invisibleLayer.length > 0) {
        invisibleLayerPos = payload.length;
        payload += FS + 'INVISIBLE' + GS + invisibleLayer + FS;
        console.log(`üîê Invisible layer added: ${encryptedCount} fields encrypted`);
    }
    
    // Add CRC to payload and record positions BEFORE padding
    const crcHigh = (crc >> 8) & 0xFF;
    const crcLow = crc & 0xFF;
    const crcPosBeforePad = payload.length; // CRC will start here
    payload += String.fromCharCode(crcHigh) + String.fromCharCode(crcLow);
    const auditPosBeforePad = payload.length; // Audit trail (inventory number) will start here
    // Get inventory number from input field, fallback to config default
    const inventoryInput = document.getElementById('inventory-number');
    let inventoryNumber = inventoryInput ? inventoryInput.value.trim() : config.auditTrail;
    // Ensure it's exactly 16 characters (pad or truncate)
    if (inventoryNumber.length < 16) {
        inventoryNumber = inventoryNumber.padEnd(16, '0');
    } else if (inventoryNumber.length > 16) {
        inventoryNumber = inventoryNumber.substring(0, 16);
    }
    payload += inventoryNumber;
    console.log(`üìã Inventory Number (Audit Trail): ${inventoryNumber}`);

    // HMAC-SHA256 (if enabled and key present) - sign the payload up to this point (before padding)
    let hmacHex = null;
    let hmacPosBeforePad = -1;
    let hmacTime = 0;
    if (hmacEnabled && hmacKey) {
        const hmacStart = performance.now();
        hmacHex = await signHMACHex(payload);
        hmacTime = performance.now() - hmacStart;
        const hmacBytes = hexToBytes(hmacHex);
        hmacPosBeforePad = payload.length;
        // append raw bytes
        payload += Array.from(hmacBytes).map(b => String.fromCharCode(b)).join('');
        console.log('üîê HMAC appended:', hmacHex.substring(0, 32) + '...');
    }

    // Pad to TARGET_SIZE (e.g., 1024 bytes)
    const TARGET_SIZE = 1024;
    const paddingNeeded = TARGET_SIZE - payload.length;
    
    if (paddingNeeded > 0) {
        payload += '\x00'.repeat(paddingNeeded);
    }
    
    console.log('Final payload size:', payload.length);
    
    return {
        payload: payload,
        structure: {
            preambleLen: PREAMBLE_LEN,
            headerLen: header.length,
            dlOffset: DL_OFFSET,
            dlLength: DL_LENGTH,
            stateOffset: STATE_OFFSET,
            stateLength: STATE_LENGTH,
            terminatorPos: payload.indexOf(RS),
            crcPos: crcPosBeforePad,
            auditPos: auditPosBeforePad,
            inventoryNumber: inventoryNumber,
            hmacPos: hmacPosBeforePad,
            invisibleLayerPos: invisibleLayerPos,
            totalSize: payload.length,
            crcValue: crc,
            crcHex: '0x' + crc.toString(16).toUpperCase().padStart(4, '0'),
            crcTime: crcTime,
            md5Hash: md5Hash,
            md5Time: md5Time,
            hmacHex: hmacHex,
            hmacTime: hmacTime,
            state: currentState,
            subfileId: subfileId,
            iin: IIN,
            aamvaVer: AAMVA_VER,
            jurVer: JUR_VER,
            dlFieldsIncluded: includedFields,
            dlFieldsOmitted: omittedFields,
            stateFieldsIncluded: stateIncluded,
            encryptedFields: encryptedCount,
            aesEnabled: aesEnabled,
            md5Enabled: md5Enabled,
            hmacEnabled: hmacEnabled
        }
    };
}

// ============================================================================
// VALIDATION
// ============================================================================

function validateFields() {
    const errors = [];
    const warnings = [];
    const strictMode = document.getElementById('strict-mode')?.checked;
    const config = getCurrentConfig();
    
    FIELD_SCHEMA.forEach(field => {
        const input = document.getElementById('fld-' + field.id);
        if (!input) return;
        
        const value = input.value.trim();
        const includeRule = field.include ? (field.include[currentState] || field.include['FL'] || 'optional') : 'optional';
        
        if (includeRule === 'required' && !value) {
            errors.push(`${field.id}: REQUIRED field is empty`);
            input.style.borderColor = '#ff0000';
            return;
        } else if (includeRule === 'required') {
            input.style.borderColor = '#ffff00';
        } else if (includeRule === 'always') {
            input.style.borderColor = '#ff8800';
        } else if (aesEnabled && field.sensitive) {
            input.style.borderColor = '#ff00ff';
        } else {
            input.style.borderColor = '#00ff00';
        }
        
        if (!strictMode || !value) return;
        
        if (field.id.match(/^(DBB|DBA|DBD|DDB|DDH|DDI|DDJ|DDC|PAB|PAC)$/)) {
            if (!/^\d{8}$/.test(value)) {
                errors.push(`${field.id}: Must be MMDDYYYY (8 digits)`);
            }
        }
        
        if (field.id === 'DAJ' && value !== currentState) {
            warnings.push(`${field.id}: Should be ${currentState} for ${config.name}`);
        }
        
        if (field.id === 'DBC' && !['1', '2', '9'].includes(value)) {
            errors.push(`${field.id}: Must be 1 (Male), 2 (Female), or 9 (X)`);
        }
    });
    
    // Additional state-specific validations (Florida / IDEMIA and California)
    if (currentState === 'FL') {
        // DAJ should be 'FL'
        const daj = document.getElementById('fld-DAJ')?.value.trim();
        if (daj !== 'FL') {
            warnings.push(`DAJ should be 'FL' for Florida records`);
        }

        // DAK zip code validation: 5 or 9 digits
        const dak = document.getElementById('fld-DAK')?.value.trim();
        if (dak && !/^\d{5}(?:-\d{4})?$/.test(dak)) {
            errors.push(`DAK (Postal Code) must be 5 digits or ZIP+4`);
        }

        // DCF (Document Discriminator) must be present
        const dcf = document.getElementById('fld-DCF')?.value.trim();
        if (!dcf) {
            errors.push(`DCF (Document Discriminator) is required for Florida`);
        }

        // IDEMIA protocol enforcement
        if (!getCurrentConfig().useIdemia) {
            warnings.push(`Florida typically requires IDEMIA protocol; configuration indicates otherwise`);
        }
    }

    // California-specific validations
    if (currentState === 'CA') {
        // DAJ should be 'CA'
        const daj = document.getElementById('fld-DAJ')?.value.trim();
        if (daj !== 'CA') {
            warnings.push(`DAJ should be 'CA' for California records`);
        }

        // DAK zip code: 5 digits or ZIP+4
        const dak = document.getElementById('fld-DAK')?.value.trim();
        if (dak && !/^\d{5}(?:-\d{4})?$/.test(dak)) {
            errors.push(`DAK (Postal Code) must be 5 digits or ZIP+4`);
        }

        // DCF (Document Discriminator) presence and CA-specific format (alphanumeric)
        const dcf = document.getElementById('fld-DCF')?.value.trim();
        if (!dcf) {
            errors.push(`DCF (Document Discriminator) is required for California`);
        } else if (!/^\w{6,20}$/.test(dcf)) {
            warnings.push(`DCF should be alphanumeric and between 6-20 chars for CA`);
        }

        // DCA (License Class) should be one of known classes (common CA classes: A/B/C/D/E/M)
        const dca = document.getElementById('fld-DCA')?.value.trim();
        if (dca && !/^[A-EM]$/.test(dca)) {
            warnings.push(`DCA (License Class) for CA should be one of A/B/C/D/E/M`);
        }

        // Ensure state-specific subfile ID matches expectation
        const config = getCurrentConfig();
        if (config.subfileId !== 'ZC') {
            warnings.push(`California subfile expected to be ZC; current config: ${config.subfileId}`);
        }
    }
    
    // Validate state-specific Z subfile required fields
    const subfileSchema = getStateSubfile(currentState);
    subfileSchema.forEach(field => {
        const input = document.getElementById('fld-' + field.id);
        if (!input) return;
        
        const value = input.value.trim();
        
        if (field.include === 'required' && !value) {
            errors.push(`${field.id}: REQUIRED ${config.name} field is empty`);
            input.style.borderColor = '#ff0000';
        } else if (field.include === 'required') {
            input.style.borderColor = '#ffff00';
        } else if (field.include === 'always') {
            input.style.borderColor = '#ff8800';
        } else {
            input.style.borderColor = '#00ff00';
        }
    });
    
    return { errors, warnings };
}

// ============================================================================
// BARCODE GENERATION
// ============================================================================

async function generateBarcode() {
    console.clear();
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log(`üöÄ GENERATING ${getCurrentConfig().name} PDF417`);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    const progContainer = document.getElementById('gen-progress-container');
    const progFill = document.getElementById('gen-progress-fill');
    
    if (progContainer && progFill) {
        progContainer.style.display = 'block';
        progFill.style.width = '0%';
    }

    // Decoding reward animation
    const outputPanel = document.getElementById('barcode-output').parentElement;
    const overlay = document.createElement('div');
    overlay.className = 'decoding-overlay';
    overlay.style.display = 'block';
    overlay.innerHTML = '<div class="decoding-text">INITIALIZING...</div>';
    outputPanel.appendChild(overlay);
    
    // Chunky sound-like visual reward
    document.getElementById('btn-generate').style.transform = 'scale(0.95)';
    setTimeout(() => { document.getElementById('btn-generate').style.transform = ''; }, 150);

    const validation = validateFields();
    if (validation.errors.length > 0) {
        displayValidationResults(validation);
        return;
    }
    
    try {
        if (progFill) progFill.style.width = '20%';
        overlay.querySelector('.decoding-text').textContent = 'MAPPING...';
        
        const result = await buildDMVCompliantPayload();
        const { payload, structure } = result;
        
        if (progFill) progFill.style.width = '50%';
        overlay.querySelector('.decoding-text').textContent = 'ENCRYPTING...';
        await new Promise(r => setTimeout(r, 400));
        
        displayProtocolAnalysis(structure, payload);
        displayHexPreview(payload);
        displayChecksumComparison(structure);
        
        if (progFill) progFill.style.width = '80%';
        overlay.querySelector('.decoding-text').textContent = 'RENDERING...';
        await new Promise(r => setTimeout(r, 300));
        
        const outputDiv = document.getElementById('barcode-output');
        if (!outputDiv) return;
        
        outputDiv.innerHTML = '<h3 style="color: #ffff00; margin-bottom: 1rem;">PDF417 Barcode (ECC Level 5)</h3>';
        
        const canvas = document.createElement('canvas');
        outputDiv.appendChild(canvas);
        
        bwipjs.toCanvas(canvas, {
            bcid: 'pdf417',
            text: payload,
            eclevel: 5,
            columns: 15,
            rows: 0,
            scale: 2,
            height: 6,
            includetext: false,
            parsefnc: false,
            encoding: 'binary'
        });
        
        canvas.style.maxWidth = '100%';
        window.lastCanvas = canvas;
        
        displayValidationResults(validation, true);
        
        // Final Success Reward: Confetti & Resolve animation
        if (progFill) progFill.style.width = '100%';
        setTimeout(() => {
            overlay.remove();
            triggerConfetti();
            if (progContainer) progContainer.style.display = 'none';
        }, 800);
        
        console.log('‚úÖ SUCCESS');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
    } catch (error) {
        if (overlay) overlay.remove();
        console.error('‚ùå ERROR:', error);
        console.error(error.stack);
        const outputDiv = document.getElementById('barcode-output');
        if (outputDiv) {
            outputDiv.innerHTML = `<div class="alert alert-error"><strong>‚ùå ERROR:</strong><br>${error.message}</div>`;
        }
    }
}

// ============================================================================
// DISPLAY FUNCTIONS
// ============================================================================

function displayChecksumComparison(structure) {
    const el = document.getElementById('checksum-comparison-display');
    if (!el) return;
    
    if (!structure.md5Enabled && !structure.aesEnabled && !structure.hmacEnabled) {
        el.innerHTML = '';
        return;
    }
    
    let html = '<div class="checksum-comparison">';
    html += '<h4 style="color: #ff00ff; margin-bottom: 1rem;">üîê CRYPTOGRAPHY COMPARISON</h4>';
    
    // CRC-16
    html += '<div class="checksum-row">';
    html += '<div class="checksum-label">CRC-16-CCITT:</div>';
    html += `<div class="checksum-value">${structure.crcHex}</div>`;
    html += `<div class="checksum-time">${structure.crcTime.toFixed(3)}ms</div>`;
    html += '</div>';
    
    // MD5 (if enabled)
    if (structure.md5Enabled) {
        html += '<div class="checksum-row">';
        html += '<div class="checksum-label">MD5 Hash:</div>';
        html += `<div class="checksum-value">${structure.md5Hash}</div>`;
        html += `<div class="checksum-time">${structure.md5Time.toFixed(3)}ms</div>`;
        html += '</div>';
        
        html += '<div style="margin-top: 1rem; padding: 0.75rem; background: #1a0033; border-left: 3px solid #ff00ff; color: #cc99ff; font-size: 0.85rem;">';
        html += '<strong>üìä Comparison:</strong><br>';
        html += `‚Ä¢ CRC-16: ${(structure.crcHex.length - 2) * 4} bits (16-bit checksum)<br>`;
        html += `‚Ä¢ MD5: ${structure.md5Hash.length * 4} bits (128-bit hash)<br>`;
        html += `‚Ä¢ Speed: MD5 is ${(structure.md5Time / structure.crcTime).toFixed(1)}x slower<br>`;
        html += `‚Ä¢ Security: CRC detects errors, MD5 detects tampering (but MD5 is broken!)`;
        html += '</div>';
    }

    // HMAC (if enabled)
    if (structure.hmacEnabled && structure.hmacHex) {
        html += '<div class="checksum-row">';
        html += '<div class="checksum-label">HMAC-SHA256:</div>';
        html += `<div class="checksum-value">${structure.hmacHex}</div>`;
        html += `<div class="checksum-time">${structure.hmacTime ? structure.hmacTime.toFixed(3) + 'ms' : '‚Äî'}</div>`;
        html += '</div>';

        html += '<div style="margin-top: 1rem; padding: 0.75rem; background: #002222; border-left: 3px solid #00CC88; color: #ccffdd; font-size: 0.85rem;">';
        html += '<strong>üîê HMAC:</strong><br>';
        html += `‚Ä¢ Algorithm: HMAC-SHA256 (32-byte MAC)<br>`;
        html += `‚Ä¢ Purpose: Cryptographic authentication / tamper detection<br>`;
        html += `‚Ä¢ Note: Verify on reader before trusting payload`;
        html += '</div>';
    }
    
    // AES (if enabled)
    if (structure.aesEnabled) {
        html += '<div class="checksum-row">';
        html += '<div class="checksum-label">AES-256-GCM:</div>';
        html += `<div class="checksum-value">‚úì ${structure.encryptedFields} fields encrypted</div>`;
        html += `<div class="checksum-time">ACTIVE</div>`;
        html += '</div>';
        
        html += '<div style="margin-top: 1rem; padding: 0.75rem; background: #1a0033; border-left: 3px solid #ff00ff; color: #cc99ff; font-size: 0.85rem;">';
        html += '<strong>üîê Encryption Active:</strong><br>';
        html += `‚Ä¢ Algorithm: AES-256-GCM (Galois/Counter Mode)<br>`;
        html += `‚Ä¢ Key Size: 256 bits (32 bytes)<br>`;
        html += `‚Ä¢ IV Size: 96 bits (12 bytes, random per field)<br>`;
        html += `‚Ä¢ Encrypted: Name, DOB, Address (${structure.encryptedFields} fields)<br>`;
        html += `‚Ä¢ Note: Data is encrypted but barcode still scans!`;
        html += '</div>';
    }
    
    html += '</div>';
    el.innerHTML = html;
}

function displayProtocolAnalysis(structure, payload) {
    const el = document.getElementById('protocol-analysis');
    if (!el) return;
    
    const config = getCurrentConfig();
    
    const cryptoStatus = structure.aesEnabled ? 'üîê AES-256 ACTIVE' : '';
    const md5Status = structure.md5Enabled ? 'üìä MD5 ACTIVE' : '';
    
    let analysis = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë       ${config.name.toUpperCase()} DMV PROTOCOL STRUCTURE                    ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë State: ${structure.state}                                               ‚ïë
‚ïë IIN: ${structure.iin}                                              ‚ïë
‚ïë AAMVA Version: ${structure.aamvaVer}                                       ‚ïë
‚ïë Jurisdiction Version: ${structure.jurVer}                                 ‚ïë
‚ïë ${config.useIdemia ? 'Protocol: IDEMIA' : 'Protocol: DMV Standard'}                                 ‚ïë
‚ïë Total Size: ${structure.totalSize} bytes                                ‚ïë
‚ïë CRC-16-CCITT: ${structure.crcHex} (${structure.crcTime.toFixed(3)}ms)               ‚ïë
${structure.md5Enabled ? `‚ïë MD5 Hash: ${structure.md5Hash.substring(0, 32)}...        ‚ïë` : ''}
${structure.hmacEnabled ? `‚ïë HMAC-SHA256: ${structure.hmacHex ? structure.hmacHex.substring(0, 32) + '...' : 'Not computed'}        ‚ïë` : ''}
${structure.aesEnabled ? `‚ïë üîê AES-256: ${structure.encryptedFields} fields encrypted                   ‚ïë` : ''}
‚ïë ECC Level: 5                                              ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë FIELD INCLUSION COUNTS                                    ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë DL Subfile: ${structure.dlFieldsIncluded} included, ${structure.dlFieldsOmitted} omitted            ‚ïë
‚ïë ${structure.subfileId} Subfile: ${structure.stateFieldsIncluded} included                          ‚ïë
${structure.aesEnabled ? `‚ïë üîê Encrypted: ${structure.encryptedFields} sensitive fields                  ‚ïë` : ''}
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë SECTION         ‚îÇ OFFSET ‚îÇ LENGTH                         ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë Preamble        ‚îÇ      0 ‚îÇ      4                         ‚ïë
‚ïë Header          ‚îÇ      4 ‚îÇ ${String(structure.headerLen).padStart(6)}                         ‚ïë
‚ïë DL Subfile      ‚îÇ ${String(structure.dlOffset).padStart(6)} ‚îÇ ${String(structure.dlLength).padStart(6)}                         ‚ïë
‚ïë ${structure.subfileId} Subfile      ‚îÇ ${String(structure.stateOffset).padStart(6)} ‚îÇ ${String(structure.stateLength).padStart(6)}                         ‚ïë
‚ïë Terminators     ‚îÇ ${String(structure.terminatorPos).padStart(6)} ‚îÇ      2                         ‚ïë`;

    if (structure.invisibleLayerPos >= 0) {
        const invisibleLayerLength = structure.crcPos - structure.invisibleLayerPos;
        analysis += `
‚ïë Invisible Layer ‚îÇ ${String(structure.invisibleLayerPos).padStart(6)} ‚îÇ ${String(invisibleLayerLength).padStart(6)}                         ‚ïë`;
    }

    analysis += `
‚ïë CRC-16          ‚îÇ ${String(structure.crcPos).padStart(6)} ‚îÇ      2                         ‚ïë
‚ïë Audit Trail     ‚îÇ ${String(structure.auditPos).padStart(6)} ‚îÇ     16                         ‚ïë
${structure.hmacEnabled ? `‚ïë HMAC (32B)      ‚îÇ ${String(structure.hmacPos).padStart(6)} ‚îÇ     32                         ‚ïë` : ''}
‚ïë Padding         ‚îÇ ${String(structure.auditPos + 16 + (structure.hmacEnabled ? 32 : 0)).padStart(6)} ‚îÇ ${String(structure.totalSize - structure.auditPos - 16 - (structure.hmacEnabled ? 32 : 0)).padStart(6)}                         ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïß‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïß‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚úì Binary protocol structure verified
‚úì CRC-16-CCITT checksum calculated (Big-Endian)
${structure.md5Enabled ? '‚úì MD5 hash calculated (128-bit digest)' : ''}
${structure.aesEnabled ? '‚úì AES-256-GCM encryption applied to sensitive fields' : ''}
${structure.aesEnabled ? '‚úì Invisible layer structure implemented per AAMVA specs' : ''}
‚úì ${config.name} inventory number: ${structure.inventoryNumber}
‚úì Null padding to 1024 bytes
${config.useIdemia ? '‚úì IDEMIA protocol compliance verified' : '‚úì Standard DMV protocol verified'}
‚úì Field inclusion rules applied correctly
`.trim();
    
    el.textContent = analysis;
}

function displayHexPreview(payload) {
    const el = document.getElementById('hex-preview');
    if (!el) return;
    
    const bytes = stringToBytes(payload);
    let hex = '';
    
    for (let i = 0; i < Math.min(512, bytes.length); i += 16) {
        const offset = i.toString(16).toUpperCase().padStart(4, '0');
        const chunk = bytes.slice(i, i + 16);
        const hexPart = bytesToHex(chunk, true).padEnd(48, ' ');
        const asciiPart = chunk.map(b => 
            (b >= 32 && b <= 126) ? String.fromCharCode(b) : '.'
        ).join('');
        
        hex += `${offset}  ${hexPart}  ${asciiPart}\n`;
    }
    
    if (aesEnabled) {
        hex += `\nüîê INVISIBLE LAYER ACTIVE - Encrypted data is in invisible layer structure\n`;
    }
    
    hex += `\n... [${payload.length} total bytes]`;
    el.textContent = hex;
}

function displayValidationResults(validation, success = false) {
    const el = document.getElementById('validation-status');
    if (!el) return;
    
    const config = getCurrentConfig();
    
    if (success && validation.errors.length === 0) {
        let cryptoMsg = '';
        if (aesEnabled) cryptoMsg += '<br>üîê AES-256 encryption active - sensitive data encrypted';
        if (md5Enabled) cryptoMsg += '<br>üìä MD5 checksum calculated alongside CRC-16';
        if (hmacEnabled) cryptoMsg += '<br>üîê HMAC-SHA256 authentication tag appended to payload';
        
        el.innerHTML = `
            <div class="alert alert-success">
                <strong><span class="status-indicator status-ok"></span>‚úÖ GENERATION SUCCESSFUL</strong><br>
                ${config.name} DMV-compliant binary protocol verified
                ${config.useIdemia ? '<br>IDEMIA hardware protocol enabled' : '<br>Standard DMV protocol enabled'}
                ${cryptoMsg}
            </div>
        `;
    } else if (validation.errors.length > 0) {
        el.innerHTML = `
            <div class="alert alert-error">
                <strong><span class="status-indicator status-error"></span>‚ùå ERRORS (${validation.errors.length}):</strong><br>
                ${validation.errors.map(e => '‚Ä¢ ' + e).join('<br>')}
            </div>
        `;
    } else {
        el.innerHTML = `
            <div class="alert alert-success">
                <strong><span class="status-indicator status-ok"></span>‚úì VALIDATION PASSED</strong>
            </div>
        `;
    }
    
    if (validation.warnings.length > 0) {
        el.innerHTML += `
            <div class="alert alert-warning">
                <strong><span class="status-indicator status-warning"></span>‚ö†Ô∏è WARNINGS:</strong><br>
                ${validation.warnings.map(w => '‚Ä¢ ' + w).join('<br>')}
            </div>
        `;
    }
}

// ============================================================================
// UI RENDERING
// ============================================================================

function renderFields() {
    const container = document.getElementById('field-container');
    if (!container) return;
    
    const config = getCurrentConfig();
    let html = '';
    
    html += '<div class="section-divider">üî∑ DL SUBFILE (AAMVA Standard)</div>';
    
    FIELD_SCHEMA.forEach(field => {
        // Get include rule - default to FL rules if state not defined, or 'optional' as fallback
        let includeRule = 'optional';
        if (field.include) {
            includeRule = field.include[currentState] || field.include['FL'] || 'optional';
        }
        const exampleVal = config.exampleData[field.id] || '';
        const isSensitive = aesEnabled && field.sensitive;
        
        const labelClasses = ['field-label'];
        const inputClasses = [];
        let badgeClass = 'badge-optional';
        let badgeText = 'OPTIONAL';
        let reqMarker = '';
        const rowClasses = ['field-row'];
        
        if (includeRule === 'required') {
            labelClasses.push('mandatory');
            inputClasses.push('mandatory');
            badgeClass = 'badge-required';
            badgeText = 'REQUIRED';
            reqMarker = ' *';
        } else if (includeRule === 'always') {
            labelClasses.push('always-include');
            inputClasses.push('always-include');
            badgeClass = 'badge-always';
            badgeText = 'ALWAYS';
            reqMarker = ' +';
        }
        
        if (isSensitive) {
            labelClasses.push('encrypted-label');
            inputClasses.push('encrypted-input');
            badgeClass = 'badge-encrypted';
            badgeText = 'üîê ENCRYPTED';
            rowClasses.push('encrypted');
        }
        
        html += `
            <div class="${rowClasses.join(' ')}" title="${field.desc || ''} (${includeRule})${isSensitive ? ' - Will be encrypted' : ''}">
                <div class="${labelClasses.join(' ')}">
                    ${field.id}${reqMarker}
                    ${isSensitive ? '<span class="encryption-indicator">üîê</span>' : ''}
                </div>
                <div class="field-input">
                    <input 
                        type="text" 
                        id="fld-${field.id}" 
                        class="${inputClasses.join(' ')}"
                        value="${exampleVal}" 
                        placeholder="${field.desc || ''}"
                        ${field.readOnly ? 'readonly' : ''}
                    >
                </div>
                <div class="badge ${badgeClass}">${badgeText}</div>
            </div>
        `;
    });
    
    const subfileSchema = getStateSubfile(currentState);
    const subfileId = config.subfileId;
    
    html += `<div class="section-divider">üî∑ ${subfileId} SUBFILE (${config.name} Specific)</div>`;
    
    subfileSchema.forEach(field => {
        const includeRule = field.include;
        let exampleVal = field.defaultVal || '';
        
        // Auto-populate some Z fields from DL data
        // State-specific mappings take precedence over generic patterns
        let isStateMapped = false;
        
        // Florida ZF subfile specific mappings
        if (currentState === 'FL') {
            if (field.id === 'ZFA') { exampleVal = config.exampleData.DCA || field.defaultVal || ''; isStateMapped = true; }
            if (field.id === 'ZFB') { exampleVal = config.exampleData.DBA || field.defaultVal || ''; isStateMapped = true; }
            if (field.id === 'ZFC') { exampleVal = config.exampleData.DAQ || field.defaultVal || ''; isStateMapped = true; }
        }
        // California ZC subfile specific mappings
        if (currentState === 'CA') {
            if (field.id === 'ZCA') { exampleVal = config.exampleData.DAY || field.defaultVal || ''; isStateMapped = true; }
            if (field.id === 'ZCB') { exampleVal = config.exampleData.DAZ || field.defaultVal || ''; isStateMapped = true; }
        }
        
        // Generic patterns only apply if no state-specific mapping was found
        if (!isStateMapped) {
            if (field.id.match(/A$/)) exampleVal = config.exampleData.DCA || field.defaultVal || '';
            if (field.desc && field.desc.includes('Exp')) exampleVal = config.exampleData.DBA || field.defaultVal || '';
            if ((field.desc && field.desc.includes('Number')) || (field.desc && field.desc.includes('License #'))) exampleVal = config.exampleData.DAQ || field.defaultVal || '';
            if (field.desc && field.desc.includes('Issue')) exampleVal = config.exampleData.DBD || field.defaultVal || '';
            if ((field.desc && field.desc.includes('Control')) || (field.desc && field.desc.includes('Audit'))) exampleVal = config.exampleData.DCF || field.defaultVal || '';
        }
        
        let labelClass = 'field-label';
        let inputClass = '';
        let badgeClass = 'badge-optional';
        let badgeText = 'OPTIONAL';
        let reqMarker = '';
        
        if (includeRule === 'required') {
            labelClass = 'field-label mandatory';
            inputClass = 'mandatory';
            badgeClass = 'badge-required';
            badgeText = 'REQUIRED';
            reqMarker = ' *';
        } else if (includeRule === 'always') {
            labelClass = 'field-label always-include';
            inputClass = 'always-include';
            badgeClass = 'badge-always';
            badgeText = 'ALWAYS';
            reqMarker = ' +';
        }
        
        html += `
            <div class="field-row" title="${field.desc || ''} (${includeRule})">
                <div class="${labelClass}">${field.id}${reqMarker}</div>
                <div class="field-input">
                    <input 
                        type="text" 
                        id="fld-${field.id}" 
                        class="${inputClass}"
                        value="${exampleVal}" 
                        placeholder="${field.desc || ''}"
                    >
                </div>
                <div class="badge ${badgeClass}">${badgeText}</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function downloadPNG() {
    if (!window.lastCanvas) {
        alert('‚ö†Ô∏è Generate a barcode first');
        return;
    }
    
    triggerPrintingAnimation();
    
    window.lastCanvas.toBlob(blob => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const cryptoSuffix = aesEnabled ? '_AES256' : '';
        link.download = `${currentState}_PDF417_AAMVA${currentAAMVA}${cryptoSuffix}_${new Date().toISOString().slice(0, 10)}.png`;
        link.click();
        URL.revokeObjectURL(link.href);
    });
}

function resetToExample() {
    renderFields();
    updateConfigDisplay();
    
    document.getElementById('validation-status').innerHTML = '';
    document.getElementById('protocol-analysis').textContent = 'Awaiting generation...';
    document.getElementById('hex-preview').textContent = 'Awaiting generation...';
    document.getElementById('barcode-output').innerHTML = '';
    document.getElementById('checksum-comparison-display').innerHTML = '';
    
    console.clear();
    console.log(`üîÑ Reset to ${getCurrentConfig().name} example data`);
}

async function runTests() {
    console.clear();
    console.log('üß™ RUNNING COMPREHENSIVE CRYPTOGRAPHY TESTS...\n');
    
    // Test 1: CRC-16-CCITT
    console.log('TEST 1: CRC-16-CCITT Implementation');
    const testData = '123456789';
    const expectedCRC = 0x29B1;
    const actualCRC = crc16ccitt(testData);
    console.log('Input:', testData);
    console.log('Expected:', '0x' + expectedCRC.toString(16).toUpperCase());
    console.log('Actual:', '0x' + actualCRC.toString(16).toUpperCase());
    console.log('Result:', expectedCRC === actualCRC ? '‚úÖ PASS' : '‚ùå FAIL');
    console.log('');
    
    // Test 2: MD5 Hash
    console.log('TEST 2: MD5 Hash Implementation');
    const testString = 'The quick brown fox jumps over the lazy dog';
    const expectedMD5 = '9e107d9d372bb6826bd81d3542a419d6';
    const actualMD5 = md5Cached(testString);
    console.log('Input:', testString);
    console.log('Expected:', expectedMD5);
    console.log('Actual:', actualMD5);
    console.log('Result:', expectedMD5 === actualMD5 ? '‚úÖ PASS' : '‚ùå FAIL');
    
    // Additional MD5 vectors
    console.log('TEST 2b: MD5 Empty String');
    const emptyExpected = 'd41d8cd98f00b204e9800998ecf8427e';
    const emptyActual = md5Cached('');
    console.log('Empty MD5:', emptyActual, emptyActual === emptyExpected ? '‚úÖ PASS' : '‚ùå FAIL');
    
    console.log('TEST 2c: MD5 Large data (100k "a")');
    const bigStr = 'a'.repeat(100000);
    console.time('md5-large');
    const bigHash = md5Cached(bigStr);
    console.timeEnd('md5-large');
    console.log('Big MD5 sample (first 16 chars):', bigHash.substring(0, 16));
    console.log('');
    
    // Test 3: AES-256 Encryption/Decryption
    console.log('TEST 3: AES-256 Encryption/Decryption');
    try {
        const original = 'SECRET DATA 12345';
        const encrypted = await encryptFieldAES(original);
        const decrypted = await decryptFieldAES(encrypted);
        console.log('Original:', original);
        console.log('Encrypted:', encrypted.substring(0, 50) + '...');
        console.log('Decrypted:', decrypted);
        console.log('Result:', original === decrypted ? '‚úÖ PASS' : '‚ùå FAIL');
    } catch (e) {
        console.log('Result: ‚ùå FAIL -', e.message);
    }
    console.log('');
    
    // Test 4: Speed Comparison
    console.log('TEST 4: Checksum Speed Comparison');
    const largeData = 'A'.repeat(10000);
    
    const crcStart = performance.now();
    crc16ccitt(largeData);
    const crcTime = performance.now() - crcStart;
    
    const md5Start = performance.now();
    md5Cached(largeData);
    const md5Time = performance.now() - md5Start;
    
    console.log('Data size: 10,000 bytes');
    console.log(`CRC-16: ${crcTime.toFixed(3)}ms`);
    console.log(`MD5: ${md5Time.toFixed(3)}ms`);
    console.log(`MD5 is ${(md5Time / crcTime).toFixed(1)}x slower`);
    console.log('Result: ‚úÖ PASS (performance measured)');
    console.log('');
    
    // Test 5: Payload CRC/Audit positions (build a payload and verify positions)
    console.log('TEST 5: Payload CRC & Audit Position Verification');
    try {
        const payloadResult = await buildDMVCompliantPayload();
        const { payload, structure } = payloadResult;
        const crcFromStruct = structure.crcValue;
        const extractedCrc = (payload.charCodeAt(structure.crcPos) << 8) | payload.charCodeAt(structure.crcPos + 1);
        console.log('CRC from calculation:', '0x' + crcFromStruct.toString(16).toUpperCase());
        console.log('CRC extracted from payload:', '0x' + extractedCrc.toString(16).toUpperCase());
        console.log('CRC position check result:', crcFromStruct === extractedCrc ? '‚úÖ PASS' : '‚ùå FAIL');
        
        const expectedAudit = getCurrentConfig().auditTrail;
        const actualAudit = payload.substr(structure.auditPos, expectedAudit.length);
        console.log('Expected Audit Trail:', expectedAudit);
        console.log('Actual Audit Trail:', actualAudit);
        console.log('Audit trail check result:', actualAudit === expectedAudit ? '‚úÖ PASS' : '‚ùå FAIL');
        
    } catch (e) {
        console.log('TEST 5 Result: ‚ùå FAIL -', e.message);
    }
    console.log('');
    
    // Test 6: MD5 included in payload (now available to all users)
    console.log('TEST 6: MD5 Payload Inclusion');
    try {
        document.getElementById('enable-md5').checked = true;
        onMD5Toggle(); // should enable md5
        const resultWithMD5 = await buildDMVCompliantPayload();
        console.log('Structure says MD5 enabled:', resultWithMD5.structure.md5Enabled ? '‚úÖ YES' : '‚ùå NO');
        console.log('MD5 present:', resultWithMD5.structure.md5Enabled && resultWithMD5.structure.md5Hash ? '‚úÖ YES' : '‚ùå NO');
        // disable
        document.getElementById('enable-md5').checked = false;
        onMD5Toggle();
    } catch (e) {
        console.log('TEST 6 Result: ‚ùå FAIL -', e.message);
    }
    console.log('');

    // Test 7: HMAC Sign/Verify
    console.log('TEST 7: HMAC-SHA256 Sign & Verify');
    try {
        await generateHMACKey();
        hmacEnabled = true;
        document.getElementById('enable-hmac').checked = true;
        const signed = await buildDMVCompliantPayload();
        console.log('Structure says HMAC enabled:', signed.structure.hmacEnabled ? '‚úÖ YES' : '‚ùå NO');
        console.log('HMAC present:', signed.structure.hmacHex ? '‚úÖ YES' : '‚ùå NO');

        // Verify signature by extracting payload up to hmac position
        const payload = signed.payload;
        const hmacPos = signed.structure.hmacPos;
        const macBytes = payload.substr(hmacPos, 32);
        const macHex = Array.from(macBytes).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('').toUpperCase();
        const verified = await verifyHMACHex(macHex, payload.substring(0, hmacPos));
        console.log('HMAC verification (original):', verified ? '‚úÖ PASS' : '‚ùå FAIL');

        // Tamper test: flip a byte and expect verification to fail
        const tampered = payload.substring(0, 10) + String.fromCharCode(payload.charCodeAt(10) ^ 0xFF) + payload.substring(11, payload.length);
        const tamperedVerified = await verifyHMACHex(macHex, tampered.substring(0, hmacPos));
        console.log('HMAC tamper detection (should fail):', tamperedVerified ? '‚ùå FAIL' : '‚úÖ PASS');

        // cleanup
        hmacEnabled = false;
        document.getElementById('enable-hmac').checked = false;
    } catch (e) {
        console.log('TEST 7 Result: ‚ùå FAIL -', e.message);
    }
    console.log('');

    // Test 8: California compliance check
    console.log('TEST 8: California compliance');
    try {
        // Switch to CA profile and render fields
        currentState = 'CA';
        updateConfigDisplay();
        renderFields();

        // Validate fields (using example data populated by renderFields)
        const validation = validateFields();
        console.log('CA validation errors:', validation.errors.length === 0 ? '‚úÖ NONE' : validation.errors);
        console.log('CA validation warnings:', validation.warnings.length === 0 ? '‚úÖ NONE' : validation.warnings);

        // Build payload and assert subfile ID and audit
        const caResult = await buildDMVCompliantPayload();
        console.log('CA subfile ID:', caResult.structure.subfileId === 'ZC' ? '‚úÖ ZC' : `‚ùå ${caResult.structure.subfileId}`);
        console.log('CA audit trail:', caResult.structure.iin === getCurrentConfig().iin ? `‚úÖ IIN ${caResult.structure.iin}` : `‚ùå ${caResult.structure.iin}`);

        // revert to default FL state for subsequent use
        currentState = 'FL';
        updateConfigDisplay();
        renderFields();
    } catch (e) {
        console.log('TEST 8 Result: ‚ùå FAIL -', e.message);
    }
    console.log('');

    // Test 9: California 2017 Revision Date Compliance
    console.log('TEST 9: California 2017 Revision Date Compliance');
    try {
        // Switch to CA with full crypto enabled
        currentState = 'CA';
        updateConfigDisplay();
        renderFields();
        
        // Enable all crypto features for end-to-end test
        document.getElementById('enable-aes256').checked = true;
        await onAESToggle();
        document.getElementById('enable-md5').checked = true;
        onMD5Toggle();
        await generateHMACKey();
        hmacEnabled = true;
        document.getElementById('enable-hmac').checked = true;
        
        // Verify CA revision date field (DDB)
        const ddb = document.getElementById('fld-DDB')?.value.trim();
        console.log('CA DDB (Revision Date):', ddb);
        console.log('Expected: 08292017');
        console.log('DDB check:', ddb === '08292017' ? '‚úÖ PASS' : '‚ùå FAIL');
        
        // Verify ZCA/ZCB auto-populated from DAY/DAZ - STRICT VALIDATION
        const zca = document.getElementById('fld-ZCA')?.value.trim();
        const zcb = document.getElementById('fld-ZCB')?.value.trim();
        const day = document.getElementById('fld-DAY')?.value.trim();
        const daz = document.getElementById('fld-DAZ')?.value.trim();
        
        console.log('ZCA (Eye Color):', zca, '| DAY:', day);
        console.log('ZCB (Hair Color):', zcb, '| DAZ:', daz);
        
        const zcaPass = zca === day;
        const zcbPass = zcb === daz;
        
        console.log('ZCA auto-populate:', zcaPass ? '‚úÖ PASS' : '‚ùå FAIL');
        console.log('ZCB auto-populate:', zcbPass ? '‚úÖ PASS' : '‚ùå FAIL');
        
        // STRICT: Test fails if auto-population is wrong
        if (!zcaPass || !zcbPass) {
            throw new Error(`CA ZC auto-population failed: ZCA=${zca} (expected ${day}), ZCB=${zcb} (expected ${daz})`);
        }
        
        // Build payload with all features enabled
        const caResult = await buildDMVCompliantPayload();
        console.log('CA subfile ID:', caResult.structure.subfileId === 'ZC' ? '‚úÖ ZC' : '‚ùå FAIL');
        console.log('CA IIN:', caResult.structure.iin === '636014' ? '‚úÖ 636014' : '‚ùå FAIL');
        console.log('CA AES-256:', caResult.structure.aesEnabled ? '‚úÖ ENABLED' : '‚ùå FAIL');
        console.log('CA MD5:', caResult.structure.md5Enabled ? '‚úÖ ENABLED' : '‚ùå FAIL');
        console.log('CA HMAC:', caResult.structure.hmacEnabled ? '‚úÖ ENABLED' : '‚ùå FAIL');
        console.log('CA encrypted fields:', caResult.structure.encryptedFields, 'fields');
        
        // Cleanup
        document.getElementById('enable-aes256').checked = false;
        await onAESToggle();
        document.getElementById('enable-md5').checked = false;
        onMD5Toggle();
        hmacEnabled = false;
        document.getElementById('enable-hmac').checked = false;
        
        currentState = 'FL';
        updateConfigDisplay();
        renderFields();
        
        console.log('TEST 9 Result: ‚úÖ California 2017 compliance verified with full crypto');
    } catch (e) {
        console.log('TEST 9 Result: ‚ùå FAIL -', e.message);
    }
    console.log('');

    // Test 10: Florida 2020 IDEMIA Revision Date Compliance
    console.log('TEST 10: Florida 2020 IDEMIA Revision Date Compliance');
    try {
        // Switch to FL with full crypto enabled
        currentState = 'FL';
        updateConfigDisplay();
        renderFields();
        
        // Enable all crypto features for end-to-end test
        document.getElementById('enable-aes256').checked = true;
        await onAESToggle();
        document.getElementById('enable-md5').checked = true;
        onMD5Toggle();
        await generateHMACKey();
        hmacEnabled = true;
        document.getElementById('enable-hmac').checked = true;
        
        // Verify FL revision date field (DDB)
        const ddb = document.getElementById('fld-DDB')?.value.trim();
        console.log('FL DDB (Revision Date):', ddb);
        console.log('Expected: 03012020');
        console.log('DDB check:', ddb === '03012020' ? '‚úÖ PASS' : '‚ùå FAIL');
        
        // Verify IDEMIA protocol
        const config = getCurrentConfig();
        console.log('FL useIdemia:', config.useIdemia ? '‚úÖ TRUE (IDEMIA Protocol)' : '‚ùå FAIL');
        console.log('FL subfileId:', config.subfileId === 'ZF' ? '‚úÖ ZF' : '‚ùå FAIL');
        
        // Verify ZF fields auto-populated
        const zfa = document.getElementById('fld-ZFA')?.value.trim();
        const zfb = document.getElementById('fld-ZFB')?.value.trim();
        const zfc = document.getElementById('fld-ZFC')?.value.trim();
        const dca = document.getElementById('fld-DCA')?.value.trim();
        const dba = document.getElementById('fld-DBA')?.value.trim();
        const daq = document.getElementById('fld-DAQ')?.value.trim();
        
        console.log('ZFA (FL Class):', zfa, '| DCA:', dca);
        console.log('ZFB (FL Exp):', zfb, '| DBA:', dba);
        console.log('ZFC (FL DL#):', zfc, '| DAQ:', daq);
        console.log('ZFA auto-populate:', zfa === dca ? '‚úÖ PASS' : '‚ùå FAIL');
        console.log('ZFB auto-populate:', zfb === dba ? '‚úÖ PASS' : '‚ùå FAIL');
        console.log('ZFC auto-populate:', zfc === daq ? '‚úÖ PASS' : '‚ùå FAIL');
        
        // Build payload with all features enabled
        const flResult = await buildDMVCompliantPayload();
        console.log('FL IIN:', flResult.structure.iin === '636026' ? '‚úÖ 636026' : '‚ùå FAIL');
        console.log('FL AES-256:', flResult.structure.aesEnabled ? '‚úÖ ENABLED' : '‚ùå FAIL');
        console.log('FL MD5:', flResult.structure.md5Enabled ? '‚úÖ ENABLED' : '‚ùå FAIL');
        console.log('FL HMAC:', flResult.structure.hmacEnabled ? '‚úÖ ENABLED' : '‚ùå FAIL');
        console.log('FL encrypted fields:', flResult.structure.encryptedFields, 'fields');
        
        // Cleanup
        document.getElementById('enable-aes256').checked = false;
        await onAESToggle();
        document.getElementById('enable-md5').checked = false;
        onMD5Toggle();
        hmacEnabled = false;
        document.getElementById('enable-hmac').checked = false;
        
        console.log('TEST 10 Result: ‚úÖ Florida 2020 IDEMIA compliance verified with full crypto');
    } catch (e) {
        console.log('TEST 10 Result: ‚ùå FAIL -', e.message);
    }
    console.log('');

    console.log('üß™ TESTS COMPLETE');
}

// ============================================================================
// EVENT HANDLERS
// ============================================================================

function onStateChange() {
    const main = document.querySelector('main');
    
    // Satisfying state change reward: Motion blur + Slide
    main.animate([
        { transform: 'translateX(50px) skewX(-10deg)', filter: 'blur(15px)', opacity: 0 },
        { transform: 'translateX(0) skewX(0deg)', filter: 'blur(0)', opacity: 1 }
    ], { duration: 400, easing: 'cubic-bezier(0.19, 1, 0.22, 1)' });

    main.classList.add('glitch-active');
    setTimeout(() => main.classList.remove('glitch-active'), 300);

    currentState = document.getElementById('profile-state').value;
    updateConfigDisplay();
    renderFields();
    console.log(`üìç Switched to ${getCurrentConfig().name}`);
}

function triggerConfetti() {
    for (let i = 0; i < 50; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + 'vw';
        c.style.top = '-10px';
        c.style.backgroundColor = Math.random() > 0.5 ? 'var(--neon-green)' : 'var(--neon-magenta)';
        c.style.transform = `rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(c);
        
        const fallDuration = 1 + Math.random() * 2;
        const drift = (Math.random() - 0.5) * 200;
        
        c.animate([
            { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
            { transform: `translate(${drift}px, 100vh) rotate(720deg)`, opacity: 0 }
        ], {
            duration: fallDuration * 1000,
            easing: 'cubic-bezier(.25,.46,.45,.94)'
        }).onfinish = () => c.remove();
    }
}

function onAAMVAChange() {
    currentAAMVA = document.getElementById('profile-aamva').value;
    updateConfigDisplay();
    console.log(`üìä AAMVA version set to ${currentAAMVA}`);
}

function onJurisdictionChange() {
    currentJurisdiction = document.getElementById('profile-jurisdiction').value;
    updateConfigDisplay();
    console.log(`üìã Jurisdiction version set to ${currentJurisdiction}`);
}

function onAESToggle() {
    aesEnabled = document.getElementById('enable-aes256').checked;
    const status = document.getElementById('aes-status');
    const panel = document.getElementById('aes-toggle-panel');
    const keyDisplay = document.getElementById('encryption-key-display');
    
    if (aesEnabled) {
        // Visual Reward: Power up flash
        const flash = document.createElement('div');
        flash.className = 'power-up-effect';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 400);

        status.textContent = 'ON';
        status.classList.remove('off');
        status.classList.add('on');
        panel.classList.add('active');
        keyDisplay.style.display = 'block';
        generateAESKey();
        console.log('üîê AES-256 ENCRYPTION ENABLED');
    } else {
        status.textContent = 'OFF';
        status.classList.remove('on');
        status.classList.add('off');
        panel.classList.remove('active');
        keyDisplay.style.display = 'none';
        console.log('üîì AES-256 ENCRYPTION DISABLED');
    }
    
    updateConfigDisplay();
    renderFields();
}

function onMD5Toggle() {
    const checkbox = document.getElementById('enable-md5');

    md5Enabled = checkbox.checked;
    const status = document.getElementById('md5-status');
    const panel = document.getElementById('md5-toggle-panel');
    
    if (md5Enabled) {
        status.textContent = 'ON';
        status.classList.remove('off');
        status.classList.add('on');
        panel.classList.add('active');
        console.log('üìä MD5 CHECKSUM ENABLED');
    } else {
        status.textContent = 'OFF';
        status.classList.remove('on');
        status.classList.add('off');
        panel.classList.remove('active');
        console.log('üìä MD5 CHECKSUM DISABLED');
    }
    
    updateConfigDisplay();
}

// HMAC event handlers
function onHMACToggle() {
    const checkbox = document.getElementById('enable-hmac');
    const status = document.getElementById('hmac-status');
    const panel = document.getElementById('hmac-toggle-panel');

    if (checkbox.checked) {
        // Require a key to be present
        if (!hmacKey) {
            checkbox.checked = false;
            alert('Load or generate an HMAC key before enabling HMAC.');
            return;
        }
        hmacEnabled = true;
        status.textContent = 'ON';
        status.classList.remove('off');
        status.classList.add('on');
        panel.classList.add('active');
        console.log('üîê HMAC-SHA256 ENABLED');
    } else {
        hmacEnabled = false;
        status.textContent = 'OFF';
        status.classList.remove('on');
        status.classList.add('off');
        panel.classList.remove('active');
        console.log('üîì HMAC-SHA256 DISABLED');
    }

    updateConfigDisplay();
}

async function onGenerateHMACKey() {
    await generateHMACKey();
    alert('HMAC key generated and populated in the key field. Save it securely for verification.');
}

async function onImportHMACKey() {
    const hex = document.getElementById('hmac-key-hex').value.trim();
    if (!hex) { alert('Enter hex key to import'); return; }
    const ok = await importHMACKeyHex(hex);
    if (ok) {
        alert('HMAC key imported');
        // auto-enable HMAC if user chooses
        document.getElementById('enable-hmac').checked = true;
        onHMACToggle();
    } else alert('Failed to import HMAC key');
}

async function verifyAdminToken(token) {
    // Try server-side verification first if endpoint exists
    try {
        const resp = await fetch(`${ADMIN_API_PATH}?token=${encodeURIComponent(token)}`, { method: 'GET' });
        if (resp.ok) {
            const j = await resp.json();
            if (j && j.admin === true) return true;
        }
    } catch (e) {
        // ignore network errors and fall back to client-side check
    }

    // Fallback: simple client-side token comparison
    return token === ADMIN_TOKEN;
}

async function onAdminUnlock() {
    const token = document.getElementById('admin-token-input').value.trim();
    if (!token) { alert('Enter admin token'); return; }
    try {
        const ok = await verifyAdminToken(token);
        setAdminMode(ok);
        if (!ok) alert('Admin token invalid');
    } catch (e) {
        alert('Error verifying admin token: ' + e.message);
    }
}

function setAdminMode(enabled) {
    adminMode = !!enabled;
    const status = document.getElementById('admin-status');
    const tokenInput = document.getElementById('admin-token-input');
    const md5Checkbox = document.getElementById('enable-md5');

    if (adminMode) {
        status.textContent = 'ADMIN ON';
        status.classList.remove('off');
        status.classList.add('on');
        tokenInput.disabled = true;
        console.log('üîë Admin mode enabled');
    } else {
        status.textContent = 'ADMIN OFF';
        status.classList.remove('on');
        status.classList.add('off');
        tokenInput.disabled = false;
        console.log('üîí Admin mode disabled');
    }

    updateConfigDisplay();
}

// ============================================================================
// INITIALIZATION
// ============================================================================

function init() {
    console.clear();
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('‚úÖ MULTI-STATE DMV PDF417 GENERATOR');
    console.log('    CRYPTOGRAPHY EDITION');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('‚úÖ States: Florida (636026) & California (636014)');
    console.log('‚úÖ AAMVA Versions: 08, 09, 10');
    console.log('‚úÖ Jurisdiction Versions: 01, 02');
    console.log('‚úÖ Field Inclusion: required/always/optional');
    console.log('‚úÖ CRC-16-CCITT (0x1021)');
    console.log('‚úÖ AES-256-GCM Encryption (Toggle)');
    console.log('‚úÖ MD5 Hash Comparison (Toggle)');
    console.log('‚úÖ Binary Mode | ECC Level 5');
    console.log('‚úÖ Barcode Scanning (Toggle)');
    console.log('‚úÖ Live Messenger (Admin)');
    console.log('‚úÖ Progress Indicators');
    console.log('‚úÖ Optimized CRC Calculations');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    
    // Initialize auth system FIRST
    initAuth();
    
    if (!window.bwipjs) {
        alert('‚ö†Ô∏è bwip-js library not loaded!');
        return;
    }
    
    if (!window.crypto || !window.crypto.subtle) {
        alert('‚ö†Ô∏è Web Crypto API not available! AES-256 encryption will not work.\nUse HTTPS or modern browser.');
    }
    
    updateConfigDisplay();
    renderFields();
    // Ensure admin-controlled UI starts locked
    setAdminMode(false);
    
    // Event listeners
    document.getElementById('profile-state')?.addEventListener('change', onStateChange);

    // Micro-reward for all inputs
    FIELD_SCHEMA.forEach(f => {
        const el = document.getElementById('fld-' + f.id);
        if (el) {
            el.addEventListener('blur', () => {
                if (el.value.trim().length > 0) pulseField(f.id);
            });
        }
    });

    // Chunky button glow bursts
    document.querySelectorAll('.btn').forEach(b => {
        b.addEventListener('click', () => {
            b.animate([
                { boxShadow: '0 0 0 0 var(--neon-green-glow)' },
                { boxShadow: '0 0 30px 10px transparent' }
            ], { duration: 400, easing: 'ease-out' });
        });
    });
    document.getElementById('profile-aamva')?.addEventListener('change', onAAMVAChange);
    document.getElementById('profile-jurisdiction')?.addEventListener('change', onJurisdictionChange);
    document.getElementById('inventory-number')?.addEventListener('input', updateConfigDisplay);
    document.getElementById('enable-aes256')?.addEventListener('change', onAESToggle);
    document.getElementById('enable-md5')?.addEventListener('change', onMD5Toggle);
    document.getElementById('btn-admin-unlock')?.addEventListener('click', onAdminUnlock);
    document.getElementById('enable-hmac')?.addEventListener('change', onHMACToggle);
    document.getElementById('btn-generate-hmac-key')?.addEventListener('click', onGenerateHMACKey);
    document.getElementById('btn-import-hmac-key')?.addEventListener('click', onImportHMACKey);
    document.getElementById('btn-set-api-key')?.addEventListener('click', () => {
        const v = document.getElementById('admin-api-key-input')?.value.trim();
        setAdminApiKey(v);
        alert('API key saved locally');
    });
    // Barcode scanning (placeholder - no actual scanning elements in this version)
    // document.getElementById('btn-scan-barcode')?.addEventListener('click', startBarcodeScan);
    // document.getElementById('scan-input')?.addEventListener('change', handleScanResult);

    // Populate API key input from storage
    const apiInput = document.getElementById('admin-api-key-input');
    if (apiInput && adminApiKey) apiInput.value = adminApiKey;

    // Admin panel listeners
    document.getElementById('btn-admin-login')?.addEventListener('click', adminLogin);
    document.getElementById('btn-admin-logout')?.addEventListener('click', adminLogout);
    document.getElementById('btn-load-users')?.addEventListener('click', loadAdminUsers);
    document.getElementById('btn-load-logs')?.addEventListener('click', loadAdminLogs);
    document.getElementById('btn-load-balances')?.addEventListener('click', loadBalances);
    document.getElementById('btn-load-chat')?.addEventListener('click', loadChat);
    document.getElementById('btn-create-user')?.addEventListener('click', createUser);
    document.getElementById('btn-credit')?.addEventListener('click', creditAccount);
    document.getElementById('btn-send-chat')?.addEventListener('click', sendChatMessage);
    
    document.getElementById('btn-generate')?.addEventListener('click', generateBarcode);
    document.getElementById('btn-validate')?.addEventListener('click', () => {
        const validation = validateFields();
        displayValidationResults(validation);
    });
    document.getElementById('btn-download')?.addEventListener('click', downloadPNG);
    document.getElementById('btn-reset')?.addEventListener('click', resetToExample);
    document.getElementById('btn-test')?.addEventListener('click', runTests);
    
    // Periodic ambient smoke from logo feet
    setInterval(() => {
        if (document.getElementById('logo-smoke')) {
            puffHeaderSmoke(1);
        }
    }, 4000);
    
    // Initial smoke puff to show it's alive
    setTimeout(() => {
        puffHeaderSmoke(3);
        puffChatSmoke(2);
    }, 1000);
    
    console.log('‚úÖ System ready\n');
    console.log('‚úÖ Interactive logo with smoke from feet');
    console.log('‚úÖ Help chat widget with smoke effects');
    console.log('‚úÖ Barcode scanning functionality');
    console.log('‚úÖ Progress indicators for long operations');
    console.log('‚úÖ Optimized CRC calculations');
    console.log('Field inclusion rules:');
    console.log('  * = REQUIRED (yellow) - Must have data');
    console.log('  + = ALWAYS (orange) - Include even if empty');
    console.log('  üîê = ENCRYPTED (magenta) - AES-256 active');
    console.log('  (no marker) = OPTIONAL (green) - Omit if empty\n');
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

</script>
</body>
</html>